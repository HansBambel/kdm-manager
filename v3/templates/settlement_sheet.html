<!-- top nav - DEPRECATED -->
<div id="topNavBar" class="settlement_sheet_gradient">
    <button
        id="floatingRefreshButton"
        class="clickable kd_yellow font_large circular_button"
        ng-if="settlement.sheet !== undefined"
        ng-click="
            showFullPageLoader();
            initializeSettlement('settlementSheet', '$api_url','$settlement_id')
        "
    >
        &#8634;
    </button>
</div>

<script
    src="/js/settlementSheet.js?v=$application_version"
    ng-init="setSessionVars('$user_login','$current_session');"
></script>

<div
    id="settlementSheetApp"
    ng-controller="settlementSheetController"
    ng-init="initializeSettlement('settlementSheet', '$api_url','$settlement_id')"
>

    <!-- tabs -->
    <div
        id="viewTabContainer"
        ng-if="settlement.sheet !== undefined"
    >

        <div
            ng-repeat="tab in tabsObject.tabs"
            id="{{'settlementSheetTabButton-' + tab.id}}"
            class="view_tab_button"
            ng-class="{'active': tabsObject.activeTab === tab.id}"
            ng-click="changeTab(tab.id);"
        >
            {{tab.name}}
        </div>

    </div>

    <!-- 'Sheet' tab starts here -->
    <div
        id="settlementSheetSheetTab"
        class="view_tab"
        ng-show='tabsObject.activeTab === 0'
    >

        <!-- once we get the settlement, init the user -->
        <span
            class="hidden"
            ng-if="settlement != undefined"
            ng-init="initializeUser('$user_id')"
        >
            Hack City!
        </span>


        <div id="settlementSheetLeftColumn" ng-if="settlement != undefined">

            <div
                id="settlementName"
                contentEditable="true"
                class="settlement_name"
                ng-model="scratch.newSettlementName"
                ng-placeholder="Settlement Name"
                ng-blur="setSettlementName()"
                title="Tap or click to edit settlement name!"
            />
                {{settlement.sheet.name}}
            </div>

            <p
                id="campaign_type"
                class="campaign_type"
                title="Campaign type may not be changed after a settlement is created!"
            >
                {{settlement.game_assets.campaign.name}}
            </p>

            <h1
                ng-if="settlement.sheet.abandoned"
                class="settlement_abandoned_stamp"
            >
                ABANDONED
            </h1>


            <!-- settlement sheet tumblers start here -->
			<div
				id="settlementTumblerScold"
				class="ng_fade kd_sheet_ui_row_tip"
				ng-click="showHide('settlementTumblerScold')"
			    ng-if="
					user.user.preferences.show_ui_tips &&
					scratch.showSettlementTumblerScold
				"
			>
				<p> The Manager tracks the settlement's Survival Limit,
				Population and Death Count automatically. Please use the manual
				controls below with care!</p>
				<p>(Tap or click to dismiss.)</p>
			</div>

			<div
				id="lanternYearScold"
				class="ng_fade kd_sheet_ui_row_tip"
				ng-click="scratch.showLanternYearScold = false"
			    ng-if="scratch.showLanternYearScold"
			>   
                <p>Please click on the menu button in the upper left corner
                and use the <b>Timeline</b> controls to update the Lantern Year.</p>
				<p>(Tap or click to dismiss.)</p>
			</div>

            <div
				class="settlement_sheet_tumblers_container"
			>

                <div
                    class="settlement_sheet_tumbler"
                >
                    <div
                        class="settlement_sheet_tumbler_click_on"
                        ng-click="scratch.showLanternYearScold = true"
                    >
                        <div
                            class="settlement_sheet_tumbler_number"
                        >
                                {{settlement.sheet.lantern_year}}
                        </div>
                        <div
                            class="settlement_sheet_tumbler_name"
                        >
                            Lantern Year
                        </div>
                    </div> <!-- tumbler_click_on -->
                </div> <!-- one-off tumbler -->

                <div
                    class="settlement_sheet_tumbler"
                    ng-repeat="attrib in [
                        'survival_limit', 'population', 'death_count'
                    ]"
                >

                    <div
                        class="settlement_sheet_tumbler_click_on"
                        ng-click="
					        scratch.showSettlementTumblerScold = true;
                            rollUp(attrib + 'Controls')
                        "
                    >

                        <div
                            class="settlement_sheet_tumbler_number"
                            ng-class="{
                                'active': ngRolledUp[attrib + 'Controls'] === false,
                            }"
                        >
                            {{settlement.sheet[attrib]}}
                        </div>

                        <div
                            class="settlement_sheet_tumbler_name"
                            ng-if="ngRolledUp[attrib + 'Controls'] !== false"
                        >
                            {{attrib.replace("_", " ")}}
                        </div>
                        <div
                            class="settlement_sheet_tumbler_name"
                            ng-if="ngRolledUp[attrib + 'Controls'] === false"
                        >
                            &#9662;
                        </div>

                    </div> <!-- tumbler_click_on -->
    
                </div> <!-- settlement_sheet_tumbler repeater -->

                <!-- lantern research level -->

                <div
                    class="settlement_sheet_tumbler"
                    ng-if="
                        settlement.sheet.locations.indexOf('exhausted_lantern_hoard') != -1
                    "
                >
                    <div
                        class="settlement_sheet_tumbler_click_on"
                        ng-click="rollUp('lanternResearchControls')"
                    >
                        <div
                            class="settlement_sheet_tumbler_number"
                            ng-class="{
                                'active': ngRolledUp['lanternResearchControls'] === false,
                            }"
                        >
                                {{settlement.sheet.lantern_research_level}}
                        </div>
                        <div
                            class="settlement_sheet_tumbler_name"
                            ng-if="ngRolledUp['lanternResearchControls'] !== false"
                        >
                            Lantern Research
                        </div>
                        <div
                            class="settlement_sheet_tumbler_name"
                            ng-if="ngRolledUp['lanternResearchControls'] === false"
                        >
                            &#9662;
                        </div>
                    </div> <!-- tumbler_click_on -->
                </div> <!-- one-off tumbler -->

            </div> <!-- TUMBLERs END; tumbler controls begin! -->


            <div class="settlement_sheet_tumbler_controls_container">

                <div
                    id="survival_limitControls"
                    class="kd_sheet_ui_roll_down rolled_up settlement_sheet_tumbler_controls"
                >

                    <div class="settlement_sheet_tumbler_control_title">
                        Survival Limit
                    </div>

                    <div class="settlement_sheet_tumbler_control_raft">
                        <button
                            ng-click="incrementAttrib('survival_limit', 1)"
                        >
                           &#9652;
                        </button>

                        <button
                            ng-click="incrementAttrib('survival_limit', -1)"
                            ng-disabled= "
                                settlement.sheet.survival_limit === settlement.sheet.minimum_survival_limit
                            "
                        >
                            &#9662;
                        </button>
                    </div> <!-- control raft -->

                    <div class="settlement_sheet_tumbler_tip">

                        <p>
                            The minimum Survival Limit for <b>{{settlement.sheet.name}}</b>,
                            based on settlement innovations and principles, is 
                            <b>{{settlement.sheet.minimum_survival_limit}}</b>.
                            <span ng-if="settlement.sheet.enforce_survival_limit == true">
                                The settlement Survival <i>Limit</i> of
                                <b>{{settlement.sheet.survival_limit}}</b> is
                                automatically enforced on the Survivor Sheet!
                            </span>
                            <span ng-if="settlement.sheet.enforce_survival_limit == false">
                                Due to expansion or campaign rules, the settlement
                                Survival Limit of <b>{{settlement.sheet.survival_limit}}</b>
                                is <u>not</u> enforced on the Survivor Sheet!
                            </span>
                        </p>

                    </div> <!-- tip -->

                    <div
                        class="settlement_sheet_tumbler_close_button_container"
                        ng-click="
                            rollUp('survival_limitControls');
                        "
                    >
                        <button class="kd_kickstarter_button kd_blue">Save and Close</button>
                    </div>

                </div> <!-- survivalControls -->


                <div
                    id="populationControls"
                    class="kd_sheet_ui_roll_down rolled_up settlement_sheet_tumbler_controls"
                >

                    <div class="settlement_sheet_tumbler_control_title">
                        Population
                    </div>

                    <div class="settlement_sheet_tumbler_control_raft">

                        <button
                            ng-click="incrementAttrib('population', 1)"
                        >
                            &#9652;
                        </button>
                        <button
                            ng-click="incrementAttrib('population', -1)"
                            ng-disabled= "
                                settlement.sheet.population === settlement.sheet.minimum_population
                            "
                        >
                            &#9662;
                        </button>

                    </div> <!-- control raft -->

                    <div class="settlement_sheet_tumbler_tip">

                        <p>
                            The minimum Population for <b>{{settlement.sheet.name}}</b>,
                            based on the total number of living survivors in the
                            settlement, is <b>{{settlement.sheet.minimum_population}}</b>.
                        </p>

                    </div> <!-- tip -->

                    <div
                        class="settlement_sheet_tumbler_close_button_container"
                        ng-click="rollUp('populationControls')"
                    >
                        <button class="kd_kickstarter_button kd_blue">Save and Close</button>
                    </div>

                </div> <!-- POPULATION controls END -->


                <div
                    id="death_countControls"
                    class="kd_sheet_ui_roll_down rolled_up settlement_sheet_tumbler_controls"
                >

                    <div class="settlement_sheet_tumbler_control_title">
                        Death Count
                    </div>

                    <div class="settlement_sheet_tumbler_control_raft">

                        <button
                            ng-click="incrementAttrib('death_count',1)"
                        >
                            &#9652;
                        </button>
                        <button
                            ng-click="incrementAttrib('death_count',-1)"
                            ng-disabled= "
                                settlement.sheet.death_count === settlement.sheet.minimum_death_count
                            "
                        >
                            &#9662;
                        </button>

                    </div> <!-- control raft -->

                    <div class="settlement_sheet_tumbler_tip">

                        <p>
                            The minimum Death Count for <b>{{settlement.sheet.name}}</b>,
                            based on the total number of dead survivors in the
                            settlement, is <b>{{settlement.sheet.minimum_death_count}}</b>.
                        </p>

                    </div> <!-- tip -->

                    <div
                        class="settlement_sheet_tumbler_close_button_container"
                        ng-click="rollUp('death_countControls')"
                    >
                        <button class="kd_kickstarter_button kd_blue">Save and Close</button>
                    </div>

                </div> <!-- DEATH COUNT controls -->

                <div
                    id="lanternResearchControls"
                    class="kd_sheet_ui_roll_down rolled_up settlement_sheet_tumbler_controls"
                >
                    <div class="settlement_sheet_tumbler_control_title">
                        Lantern Research Level
                    </div>

                    <div class="settlement_sheet_tumbler_control_raft">
                        <button
                            ng-click="incrementAttrib('lantern_research_level', 1)"
                        >
                           &#9652;
                        </button>

                        <button
                            ng-click="incrementAttrib('lantern_research_level', -1)"
                            ng-disabled= "
                                settlement.sheet.lantern_research_level === 0
                            "
                        >
                            &#9662;
                        </button>
                    </div> <!-- control raft -->

                    <div class="settlement_sheet_tumbler_tip">
                        <p>
                            <b>Once per lantern year, spend 2 x Bone, 2 x hide,
                            2 x organ to research.</b>
                        </p>
                        <p>
                            If you do, gain the next level of Lantern Research.
                        </p>
                        <p>
                            Corresponding <b>Pulse Discoveries</b> are displayed
                            on the Campaign Summary view.
                        </p>
                    </div> <!-- tip -->

                    <div
                        class="settlement_sheet_tumbler_close_button_container"
                        ng-click="
                            rollUp('lanternResearchControls');
                        "
                    >
                        <button class="kd_kickstarter_button kd_blue">Save and Close</button>
                    </div>

                </div> <!-- lanternResearchControls -->

            </div> <!-- settlement_sheet_tumbler_controls_container -->

        <!-- MILESTONES -->

        <div
            id="settlementSheetMilestonesContainer"
            class="settlement_sheet_block_group"
            ng-controller="milestonesController"
        >
            <h2>Milestone Story Events</h2>
            <p>Trigger these story events when milestone condition is met.</p>

            <div
                ng-repeat="m in settlement.game_assets.milestones_options"
                class="clickable hover_highlight settlement_sheet_milestone_content_container"
                ng-click="toggleMilestone(m.handle)"
            >
                <div
                    class="settlement_sheet_milestone_checkbox_container"
                >
                    <div
                        class="kd_sheet_ui_box"
                        ng-class="{
                            'checked': settlement.sheet.milestone_story_events.indexOf(m.handle) != -1
                        }"
                    >
                    </div>
                </div>
                <div
                    class="settlement_sheet_milestone_details"
                >
                    {{m.name}}
                    <span class="milestone_story_event">
                        <font class="kdm_font">g</font> <b>{{m.story_event}}</b>
                        <span class="milestone_story_reference">
                            (p.{{settlement.game_assets.events[m.story_event_handle].page}})
                        </span>
                    </span>
                </div>
            </div> <!-- milestone div -->

        </div> <!-- block_group for milestones -->

        <!-- PRINCIPLES -->

        <div
            class="clickable hover_highlight settlement_sheet_block_group"
            ng-controller="principlesController"
            ng-click="ngShow('settlementSheetPrinciplesEditorModal')"
            title="Tap or click to edit the settlement's principles!"
                
        >
            <h2>Principles</h2>
            <p>The settlement's established principles.</p>
            <div
                class="kd_sheet_ui_row_tip"
                ng-if="
                    user.user.preferences.show_ui_tips &&
                    settlement.sheet.principles.length === 0
                "
            >
                Tap or click to edit!
            </div>

            <div
                class="settlement_sheet_principles_spinner_container"
                ng-if="settlement.sheet.principles === undefined"
            >
                <img src="/media/loading_io.gif" />
                <p>Updating settlement principles...</p>
            </div>

            <div
                ng-repeat="p in settlement.game_assets.principles_options"
                class="settlement_sheet_principle_repeater"
                ng-if="settlement.sheet.principles !== undefined"
            >

                <div
                    class="principle_option"
                    ng-repeat="o in p.options"
                    ng-if="o.checked"
                >
                    <span class="kd_sheet_ui_box checked"></span>
                    {{o.name}}
                </div>

            </div> <!-- principle repeater -->

        </div> <!-- principles settlement sheet block group -->

        <div
            id="settlementSheetPrinciplesEditorModal"
            ng-controller="principlesController"
            ng-if="
                ngVisible['settlementSheetPrinciplesEditorModal']
            "
            class="modal-black"
        >
            <div class="kd_sheet_ui_outer_ring_container">

                <div id="settlementSheetPrinciplesControls" class="kd_sheet_ui_inner_ring_container">

                <h3>Principles</h3>
                <p>The settlement's established principles.</p>
                <div
                    class="kd_sheet_ui_row_tip"
                    ng-if="user.user.preferences.show_ui_tips"
                >
                    Bonuses to <b>living</b> survivors are applied immediately
                    when a principle is selected. Bonuses to <b>new</b> and
                    <b>newborn</b> survivors are applied automatically
                    thereafter.
                </div>

                <div
                    class="settlement_sheet_principles_spinner_container"
                    ng-if="settlement.sheet.principles === undefined"
                >
                    <img src="/media/loading_io.gif" />
                    <p>Updating settlement principles...</p>
                </div>

                <div
                    ng-repeat="p in settlement.game_assets.principles_options"
                    class="settlement_sheet_principle_repeater editor"
                    ng-if="settlement.sheet.principles !== undefined"
                >

                    <div
                        class="settlement_sheet_principle_name"
                    >
                        {{p.name}}
                    </div>

                    <div
                        class="principle_option editor"
                        ng-repeat="o in p.options"
                        ng-click="set(p.handle, o)"
                    >
                        <div
                            class="principle_option_title"
                        >
                            <div
                                class="kd_sheet_ui_box"
                                ng-class="{
                                    'checked': o.checked,
                                }"
                            >
                            </div>
                            <div class="principle_option_name">
                                {{ o.name }}
                            </div>
                        </div>

                        <div
                            class="principle_option_desc"
                            ng-bind-html="o.desc|trustedHTML"
                        >
                        </div>


                    </div> <!-- individual principle option repeater-->

                </div> <!-- principle repeater -->


                <div  ng-if="settlement.sheet.principles !== undefined">

                    <h3>Unset Principles</h3>
                    <p>Unset or remove a settlement principle.</p>

                    <div
                        class="unset_principle_container"
                        ng-if="
                            settlement.game_assets.principles_options !== undefined
                        "
                    >
                        <span class="empty_bullet rm_bullet"></span>
                        <select
                            class="kd_sheet_ui_select"
                            ng-model="scratch.unset"
                            ng-change="unsetPrinciple();"
                            ng-options="p.handle as p.name for p in settlement.game_assets.principles_options"
                        >
                            <option disabled value="">Unset Principle</option>
                        </select>
                    </div> <!-- unset_principle_container -->

                </div>  <!-- unsetter container -->


                </div> <!-- sheet ui INNER ring -->
    
                <button
                    class="kd_kickstarter_button floating_close_modal_button"
                    ng-click="ngHide('settlementSheetPrinciplesEditorModal')"
                >
                    Close
                </button>


            </div> <!-- sheet ui outer ring -->
        </div><!-- principles editor-->

        <!-- inspirational statue -->
        <div
            class="settlement_sheet_block_group"
            ng-if="settlement.sheet.innovations.indexOf('sculpture') != -1"
            title="Use these controls to manage your settlement's Inspirational Statue!"
        >
            <h2>Inspirational Statue</h2>
            <p>A settlement can only have one Inspirational Statue.</p>

            <div class="line_item">
                <span class="empty_bullet" ng-if="settlement.sheet.inspirational_statue == undefined"/></span>
                <span class="bullet" ng-if="settlement.sheet.inspirational_statue != undefined"/></span>
                <select
                    ng-model="settlement.sheet.inspirational_statue"
                    ng-options="
                        fa_dict.handle as fa_dict.name disable when fa_dict.select_disabled for fa_dict in settlement.game_assets.inspirational_statue_options
                    "
                    ng-change="setInspirationalStatue()"
                    ng-selected="settlement.sheet.inspirational_statue"
                >
                    <option disabled value="">Select a Fighting Art</option>
                </select>
            </div> <!-- line_item -->
        </div>

        <!-- monster volumes -->
        <div
            class="settlement_sheet_block_group"
            ng-controller="monsterVolumesController"
            ng-if="settlement.sheet.innovations.indexOf('records') != -1"
            title="Click or tap on an item to remove it from this list."
        >

            <h2>Monster Volumes</h2>
            <p>There can be up to 3 volumes for each monster.</p>

            <div
                class="line_item location_container"
                ng-repeat="v in settlement.sheet.monster_volumes"
            >
                <span class="bullet"></span>
                <span
                    class="item"
                    ng-click="rmMonsterVolume($index, v)"
                >
                    {{v}}
                </span>
            </div> <!-- line_item -->

            <div class="line_item">
                <span class="empty_bullet"></span>
                <select
                    ng-model="scratch.monster_volume"
                    ng-options="m_string for m_string in settlement.game_assets.monster_volumes_options"
                    ng-change="addMonsterVolume()"
                >
                    <option disabled value="">Add a Monster Volume</option>
                </select>
            </div> <!-- line_item -->

        </div>


    </div> <!-- asset_management_left_pane/left column -->





        <!-- MIDDLE PANE STARTS HERE -->

    <div id="settlementSheetMiddleColumn" ng-if="settlement != undefined">

                    <!-- LOCATIONS -->


        <!-- locations -->
        <div
            class="settlement_sheet_block_group"
            ng-controller="locationsController"
            title="Click or tap an item to remove it from this list."
        >

            <h2>Settlement Locations</h2>
            <p>Locations in your settlement.</p>

            <div
                class="line_item location_container"
                ng-repeat="loc in settlement.sheet.locations"
                ng-init="
                    l_dict = settlement.game_assets.locations[loc]
                "
            >

                <span class="bullet"></span>

                <span
                    class="clickable hover_highlight_red item"
                    ng-click="rmLocation($index, loc)"
                >
                    {{l_dict.name}}
                </span>

                <span
                    ng-if="l_dict.levels !== undefined"
                    ng-init="locationLevel = (settlement.sheet.location_levels[loc]) || 1"
                    class="location_lvl_select"
                >
                    <select
                        class="location_level"
                        ng-model="locationLevel"
                        ng-options="locationLevel as 'Lvl. '+ locationLevel for locationLevel in [1,2,3]"
                        ng-change="setLocationLevel(loc, locationLevel)"
                        ng-selected="locationLevel"
                    >
                    </select>
                </span> <!-- optional levels controls -->

            </div> <!-- line_item location_container: list/rm locations -->

            <div class="line_item">
                <span class="empty_bullet" /></span>
                <select
                    name="add_location"
                    ng_model="newLocation"
                    ng_change="addLocation()"
                    ng-options="loc.handle as loc.name for loc in locationOptions"
                >
                    <option value="" disabled selected>Add Location</option>
                </select>
            </div>

        </div> <!-- settlement_sheet_block_group locations controller-->




                    <!-- INNOVATIONS -->

        <a id="edit_innovations" class="mobile_only"/></a>


        <div
            class="settlement_sheet_block_group"
            ng-controller="innovationsController"
            title="Click or tap on an item to remove it from this list."
        >

            <h2>Innovations</h2>
            <p>The settlement's innovations (including weapon masteries).</p>

            <div
                class="line_item location_container"
                ng-repeat="i in settlement.sheet.innovations"
                ng-init="
                    i_dict = settlement.game_assets.innovations[i]
                "
            >
                <span class="bullet"></span>
                <span
                    class="clickable"
                    class="item"
                    ng-click="rmInnovation($index,i)"
                >
                    {{i_dict.name}}
                </span>
                <span
                    ng-if="i_dict.levels !== undefined"
                    ng-init="innovationLevel = (settlement.sheet.innovation_levels[i]) || 1"
                    class="location_lvl_select"
                >
                    <select
                        class="location_level"
                        ng-model="innovationLevel"
                        ng-options="innovationLevel as 'Lvl. '+ innovationLevel for innovationLevel in [1,2,3]"
                        ng-change="setInnovationLevel(i,innovationLevel)"
                        ng-selected="innovationLevel"
                    >
                    </select>
                </span> <!-- optional levels controls -->
            </div>

            <div class="line_item">
                <span class="empty_bullet" /></span>
                <select
                    name="add_innovation"
                    ng_model="newInnovation"
                    ng_change="addInnovation()"
                    ng-options="i.handle as i.name for i in innovationOptions"
                >
                    <option value="" disabled selected>Add Innovation</option>
                </select>
            </div>

            <div
                id="innovationDeckContainer"
                class="innovation_deck kd_sheet_ui_border_box"
                title="The current innovation deck for {{settlement.sheet.name}}. Tap or click to refresh!"
                ng-if="settlement.sheet.innovations.length != 0"
                ng-init="setInnovationDeck()"
            >
                <h3 class="kd_title">Innovation Deck</h3>

                <div
                    id="innovationDeckSpinner"
                    class="ng_fade inline_spinner_container"
                    ng-if="ngVisible['innovationDeckSpinner']"
                >
                    <img
                        src="/media/loading_io.gif"
                    />
                    <p>Refreshing Innovation Deck...</p>
                </div>

                <ul
                    class="asset_deck clickable"
                    ng-click="setInnovationDeck()"
                >
                    <li ng-repeat="(handle, dict) in innovation_deck"> {{dict['name']}} </li>
                </ul>

                <div
                    class="innovation_quick_pick_container"
                    ng-if="user.user.subscriber.level > 1"
                >
                    <button
                        id="innovationQuickPickLauncher"
                        class="kd_kickstarter_button kd_blue"
                        ng-if="innovation_deck != undefined"
                        onClick="
                            showHide('innovationQuickPickLauncher');
                            showHide('innovationQuickPick')
                        "
                        ng-click="createInnovationQuickPick()"
                    >
                        Innovate!
                    </button>
                    <div
                        id="innovationQuickPick"
                        class="innovation_quick_pick hidden"
                    >
                        <div class="kd_sheet_ui_row_tip">
                            Click on an innovation below to add it to settlement innovations!
                        </div>
                        <div
                            class="clickable innovation_quick_pick_item card_gradient"
                            ng-repeat="h in innovationQuickPickOptions"
                            ng-init="i = settlement.game_assets.innovations[h]"
                            ng-click="addInnovation(h); showHide('innovationQuickPick')"
                        >
                            <div class="innovation_name">{{i.name}}</div>
                            <div class="innovation_consequences" ng-if="i.consequences.length > 0">
                                Consequences:
                                <span
                                    class="innovation_consequences_repeater"
                                    ng-repeat="c_handle in i.consequences track by $index"
                                    ng-if="settlement.game_assets.innovations[c_handle]"
                                >
                                    {{settlement.game_assets.innovations[c_handle].name}}
                                <span>
                            </div>
                            <div
                                class="innovation_survival_limit_bar"
                                ng-if="i.survival_limit != undefined"
                            >
                                Survival Limit +{{i.survival_limit}}
                            </div>
                        </div>
                        <button
                            class="kd_kickstarter_button kd_blue"
                            ng-if="innovation_deck != undefined"
                            ng-click="createInnovationQuickPick()"
                        >
                            Draw again!
                        </button>
                        <button
                            class="kd_kickstarter_button kd_pink"
                            onClick="showHide('innovationQuickPickLauncher'); showHide('innovationQuickPick')"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            
            </div> <!-- innovationDeckContainer -->


        </div> <!-- settlement_sheet_block_group innovations-->




    </div> <!-- asset_management_left_pane -->



    <!-- END OF LEFT PANE -->



    <div
        id="settlementSheetRightColumn"
        ng-if="settlement !== undefined"
    >

    <!--
        outermost containers in this 'column' should only ever be of the
        kd_sheet_ui_border_box class; DO NOT put settlement_sheet_block_group 
        elements in this 'column' anymore; they belong in the other columns!
    -->


                    <!-- STRAIN MILESTONES -->
        <span
            class="hidden"
            ng-if="settlement != undefined"
            ng-controller="strainMilestonesController"
            ng-init="scratch.show_strain_milestone_controls = strainMilestonesPresent()"
        >HACK CITY!!!</span>

        <div
            class="kd_sheet_ui_border_box"
            ng-controller="strainMilestonesController"
            ng-if="scratch.show_strain_milestone_controls"
        >
            <div
                class="settlement_sheet_kd_sheet_ui_box"
                title="Strain Milestones controller for {{settlement.sheet.name}}. Tap or click to toggle!"
            >
                <div class="kd_sheet_ui_row title">
                     Strain Milestones
                </div>
                <div class="kd_sheet_ui_row">
                    During the Check Milestones step of the Settlement Phase, check the Milestone Strain cards first.
                </div>

                <div
                    class="strain_milestone_toggle_box hover_highlight clickable"
                    ng-repeat="m in settlement.game_assets.strain_milestones"
                    ng-click="toggleStrainMilestone(m.handle)"
                    ng-class="{active: settlement.sheet.strain_milestones.includes(m.handle)}"
                >
                    <span
                        class="kd_sheet_ui_box"
                        ng-class="{
                            checked: settlement.sheet.strain_milestones.indexOf(m.handle) != -1
                        }"
                    ></span>

                    <b>{{m.name}}</b> 

                    <div
                        class="ng_fade strain_milestone_condition"
                        ng-if="settlement.sheet.strain_milestones.indexOf(m.handle) == -1"
                        ng-bind-html="m.milestone_condition|trustedHTML">
                    </div>

                    <div
                        class="ng_fade strain_milestone_condition"
                        ng-if="settlement.sheet.strain_milestones.indexOf(m.handle) != -1"
                        ng-bind-html="m.permanent_effect|trustedHTML">
                    </div>

                    <div
                        class="strain_milestone_fighting_arts"
                    >
                        <span
                            ng-repeat="fa in settlement.game_assets.strain_milestones[m.handle].fighting_arts"
                            ng-class="{
                                faded: settlement.sheet.strain_milestones.indexOf(m.handle) == -1,
                                unlocked_strain_fa: settlement.sheet.strain_milestones.indexOf(m.handle) != -1
                            }"
                        >
                            <span
                                ng-if="settlement.sheet.strain_milestones.indexOf(m.handle) == -1"
                            >
                                &#x1F512;
                            </span>
                            <span
                                ng-if="settlement.sheet.strain_milestones.indexOf(m.handle) != -1"
                            >
                                &#x1F513; 
                            </span>
                            <b>{{settlement.game_assets.fighting_arts[fa].name}}</b> fighting art
                        </span>
                    </div>

                </div> <!-- milestone div -->

            </div> <!-- settlement_sheet_kd_sheet_ui_box -->

        </div> <!-- kd_sheet_ui_border_box for milestones -->

        <!-- /end strain -->


    <div
       ng-controller="quarriesController"
       class="kd_sheet_ui_border_box"
    >
        <div
            class="settlement_sheet_kd_sheet_ui_box"
            title="Quarries controller for {{settlement.sheet.name}}. Tap or click to remove!"
        >
            <div class="kd_sheet_ui_row title font_large">
                 Quarries
            </div>
            <div class="kd_sheet_ui_row">
                The monsters your settlement can select to hunt.
            </div>
            <div
                class="settlement_sheet_line_item location_container clickable"
                ng-controller="quarriesController"
                ng-repeat="q in settlement.sheet.quarries"
            >
                <span class="hidden">{{a}}</span>
                <span class="kd_sheet_ui_box checked"></span>
                <span
                    class="item"
                    ng-click="removeQuarry($index, q)"
                >
                    {{settlement.game_assets.monsters[q].name}}
                </span>
            </div>
        </div> <!-- settlement_sheet_kd_sheet_ui_box -->

        <span class="empty_bullet" /></span>
        <select
            class="kd_sheet_ui_select"
            ng-model="addQuarryMonster"
            ng-options="q.handle as q.name for q in settlement.game_assets.quarry_options"
            ng-change="addQuarry($index)"
        >
            <option selected disabled value="">Add Quarry Monster</option>
        </select>

    </div> <!-- quarriesController -->

                    <!-- NEMESIS MONSTERS -->

    <div
        class="nemesis_monsters_controls_container kd_sheet_ui_border_box"
        ng-controller="nemesisEncountersController"
    >
        <div
            class="settlement_sheet_kd_sheet_ui_box"
            title="Nemesis Encounters controller for {{settlement.sheet.name}}. Tap or click to edit!"
        >
            <div class="font_large kd_sheet_ui_row title">
                <img
                    class="kd_icon"
                    src="media/icons/nemesis_encounter_event.jpg"
                    ng-class="{
                        'invert_image': user.user.preferences.night_mode === true,
                    }"
                />
                Nemesis Monsters
            </div>
            <div class="kd_sheet_ui_row">
                The available nemesis encounter monsters.
            </div>
            <div
                class="settlement_sheet_line_item settlement_sheet_nemesis_line_item"
                ng-repeat="n in settlement.sheet.nemesis_monsters"
            >
                <div class="nemesis_clicker clickable" ng-click="rmNemesis($index,n)">
                    <span class="kd_sheet_ui_box checked"></span>
                    <span>{{settlement.game_assets.monsters[n].name}}</span>
                </div>
                <div class="nemesis_levels_container">
                    <div
                        class="nemesis_level_toggle clickable"
                        ng-repeat="l in range(settlement.game_assets.monsters[n].levels, 'increment')"
                        ng-click="toggleNemesisLevel(n,l)"
                    >
                        <span
                            class="kd_sheet_ui_box"
                            ng-class="{checked: settlement.sheet.nemesis_encounters[n].indexOf(l) != -1}"
                        ></span>
                        Lvl {{l}}
                    </div>
                </div>

            </div><!-- nemesis repeater / line item -->
        </div> <!-- settlement_sheet_kd_sheet_ui_box -->

        <span class="empty_bullet"></span>
        <select
            class="kd_sheet_ui_select"
            ng-model="addNemesisMonster"
            ng-options="n.handle as n.name for n in settlement.game_assets.nemesis_options"
            ng-change="addNemesis()"
        >
            <option selected disabled value="">Add Nemesis Monster</option>
        </select>
    </div> <!-- nemesis_monsters_controls_container -->


    <!-- DEFEATED MONSTERS -->
    <div
        class="kd_sheet_ui_border_box"
        ng-controller="defeatedMonstersController" title="Click or tap an item to remove it from this list."
    >
        <div
            class="settlement_sheet_kd_sheet_ui_box"
            title="Defeated Monsters controller for {{settlement.sheet.name}}. Tap or click to remove!"
        >
            <div class="font_large kd_sheet_ui_row title">
                Defeated Monsters
            </div>
            <div class="kd_sheet_ui_row">
                A list of defeated monsters and their level.
            </div>
            <div
                class="clickable settlement_sheet_line_item defeated_monsters_container"
                ng-repeat="x in settlement.sheet.defeated_monsters track by $index"
            >
                <span class="kd_sheet_ui_box checked"></span>
                <span class="item" ng-click="rmDefeatedMonster($index, x)">
                    {{x}}
                </span>
            </div>
        </div><!-- settlement_sheet_kd_sheet_ui_box -->

        <div class="line_item">
            <span class="empty_bullet" /></span>
            <select
                class="kd_sheet_ui_select"
                ng-model="dMonst"
                ng-change="addDefeatedMonster()"
                ng-options="d as d for d in settlement.game_assets.defeated_monsters ">
            >
                <option selected disabled value="">Add Defeated Monster</option>
            </select>
        </div> <!-- line_item -->
    </div> <!-- defeatedMonstersController -->


    <!-- LOST SETTLEMENTS ANGULARJS app -->
    <div
        class="lost_settlement_controls_container kd_sheet_ui_border_box"
    >
        <div
            class="settlement_sheet_kd_sheet_ui_box clickable"
            ng-click="rollUp('lostSettlementsControl')"
            title="
                Lost Settlements controller for {{settlement.sheet.name}}.
                Tap or click to edit!
            "
        >

            <div class="font_large kd_sheet_ui_row title">
                Lost Settlements
            </div>

            <div class="kd_sheet_ui_box_row wrap">
                <span
                    class="kd_sheet_ui_box"
                    ng-repeat="
                        lostCount in [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]
                    "
                    ng-class="{
                        'checked': settlement.sheet.lost_settlements > lostCount,
                        'heavy': [4,9,14,18].indexOf(lostCount) !== -1,
                    }"
                ></span>
            </div>

            <hr>

            <div class="kd_sheet_ui_row story_tip">
                <font class="kdm_font">g</font>
                <b> Game Over</b>
                <span class="font_small">
                    (p. {{settlement.game_assets.events['core_game_over'].page}})
                </span>
            </div>

        </div> <!-- settlement_sheet_kd_sheet_ui_box -->

        <div
            id="lostSettlementsControl"
            class="kd_sheet_ui_roll_down rolled_up"
        >
            <div
                class="kd_sheet_ui_roll_down_controls embedded"
                ng-if="ngRolledUp['lostSettlementsControl'] === false"
            >
                <div class="kd_sheet_ui_row dynamic_tip wrap">
                    <div class="font_small dynamic_tip_container">
                        <div
                            class="kd_sheet_ui_box small"
                            ng-class="{checked: settlement.sheet.lost_settlements > 4}"
                        ></div>
                        <span>
                            Left Overs
                        </span>
                    </div>
                    <div class="font_small dynamic_tip_container">
                        <div
                            ng-repeat="box in [0,1]"
                            class="kd_sheet_ui_box small"
                            ng-class="{checked: settlement.sheet.lost_settlements > 9}"
                        ></div>
                        <span>
                            Those Before Us
                        </span>
                    </div>
                    <div class="font_small dynamic_tip_container">
                        <div
                            ng-repeat="box in [0,1,2]"
                            class="kd_sheet_ui_box small"
                            ng-class="{checked: settlement.sheet.lost_settlements > 14}"
                        ></div>
                        <span>
                            Ocular Parasites
                        </span>
                    </div>
                    <div class="font_small dynamic_tip_container">
                        <div
                            ng-repeat="box in [0,1,2,3]"
                            class="kd_sheet_ui_box small"
                            ng-class="{checked: settlement.sheet.lost_settlements > 19}"
                        ></div>
                        <span>
                            Rainy Season
                        </span>
                    </div>
                </div><!-- kd_sheet_ui_row.dynamic_tip.wrap -->

                <div class="kd_sheet_ui_number_tumbler">
                    <button
                        class="kd_kickstarter_button"
                        ng-click="settlement.sheet.lost_settlements = settlement.sheet.lost_settlements + 1"
                    >
                        &#x25B2;
                    </button>
                    <button
                        class="kd_kickstarter_button"
                        ng-click="settlement.sheet.lost_settlements = settlement.sheet.lost_settlements - 1"
                    >
                        &#x25BC;
                    </button>
                    <button
                        class="kd_kickstarter_button kd_blue"
                        ng-click="
                            setLostSettlements();
                            rollUp('lostSettlementsControl');
                        "
                    >
                        Save Changes
                    </button>
                </div> <!-- number tumbler -->

            </div> <!-- kd_sheet_ui_roll_down_controls.integrated -->

        </div> <!-- kd_sheet_ui_roll_down -->

    </div> <!-- lost_settlement_controls_container -->


    </div> <!-- right pane -->

</div> <!-- settlement sheet Sheet tab -->



    <!-- settlement sheet Storage tab -->

    <div
        id="settlementSheetStorageTab"
        class="view_tab"
        ng-if="settlement !== undefined && user !== undefined"
        ng-show="tabsObject.activeTab === 1"
        ng-controller="settlementSheetStorageTabController"
    >
    
        <div
            class="ng_fade full_tab_spinner"
            ng-if="settlementStorage === undefined"
        >
            <img src="/media/loading_io.gif">
            <p>Retrieving Settlement Storage...</p>
        </div>

        <div id="editStorage">

            <div
                class="storage_type_repeater"
                ng-repeat="s_type in settlementStorage"
            >
                <h3 class="storage_type_title">
                    {{s_type.name}}<span ng-if="s_type.name==='Resource'">s</span>
                    <span
                        ng-if="s_type.total"
                    >
                        ({{s_type.total}})
                    </span>
                </h3>

                <div
                    class="storage_location_keywords_rollup"
                    ng-click="refreshRollups()"
                >
                    <span
                        class="storage_location_keywords_rollup_item"
                        ng-if="s_type.keywords === undefined"
                        ng-click="s_type.keywords = 'loading'"
                    >
                        Tap or click here to recalculate keyword counts!
                    </span>
                    <span
                        class="storage_location_keywords_rollup_item"
                        ng-if="s_type.keywords === 'loading'"
                    >
                        Recalculating...
                    </span>
                    <span
                        class="storage_location_keywords_rollup_item"
                        ng-if="s_type.keywords !== undefined && s_type.keywords !== 'loading'"
                        ng-repeat="(kw, count) in s_type.keywords"
                    >
                      {{kw}}: {{count}}
                    </span>
                </div>

                <div
                    ng-repeat="loc in s_type.locations"
                    ng-init="loc.arrow=false"
                    ng-if="loc.collection.length > 0"
                    class="storage_modal_storage_location"
                >

                    <!-- inventory section clickers -->
                    <h4
                        class="clickable"
                        ng-click="
                            showHide(loc.handle + '_container');
                            flipArrow(loc);
                        "
                    >
                        {{loc.name}}
                        <span>
                            ({{loc.inventory.length}})
                        </span>
                        <span ng-if="loc.arrow == false" class="arrow">
                            &#x25BC;
                        </span>
                        <span ng-if="loc.arrow == true" class="arrow">
                            &#x25B2;
                        </span>
                    </h4>


                    <div class="hidden" id="{{loc.handle}}_container"> <!-- show hide -->
                        <div
                            class="inventory_row"
                            ng-repeat="asset in loc.collection"
                            ng-init="
                                detailId = asset.handle + '_detail';
                                asset.flippers=false
                            "
                            ng-class-even="'no_zebra'"
                            ng-class-odd="'zebra'"
                            ng-class="{
                                'zebra_pop': asset.quantity > 0,
                                inventory_row_item_last:$last
                            }"
                        >
                            <div
                                class="inventory_row_item_controls clickable"
                                ng-click="
                                    showHide(detailId);
                                    toggleFlippers(asset);
                                "
                            >
                                <span class="name">
                                    {{asset.name}}
                                </span>
                                <span class="quantity">
                                    {{asset.quantity}}
                                </span>
                            </div> <!-- controls -->

                            <div
                                class="flippers"
                                ng-if="asset.flippers"
                                ng-click="
                                    s_type.total = undefined;
                                    s_type.keywords = undefined;
                                "
                            >
                                <button
                                    ng-click="
                                        setStorage(asset, 1);
                                        loc.inventory.push(asset.handle);
                                    "
                                > + </button>
                                <button
                                    ng-disabled="asset.quantity === 0"
                                    ng-click="
                                        setStorage(asset, -1);
                                        loc.inventory.splice(loc.inventory.indexOf(asset.handle), 1);
                                    "
                                > - </button>
                            </div>

                            <div id="{{detailId}}" class="hidden inventory_row_detail">
                                   &nbsp;
                                   <div class="inventory_row_detail_keywords">
                                       <span ng-repeat="k in asset.keywords">
                                           <i>{{k}}{{$last ? '' : ', '}}</i>
                                       </span>
                                   </div>
                                   <div class="inventory_row_detail_rules" ng-if="asset.rules.length >= 1">
                                       <span ng-repeat="k in asset.rules track by $index">
                                           <b>{{k}}</b>{{$last ? '' : ', '}}
                                       </span>
                                   </div>
                                   <span
                                       ng-if="asset.desc != undefined"
                                       class="inventory_row_detail_desc"
                                       ng-bind-html="asset.desc|trustedHTML">
                                   </span>
                               </div>
                           </div>
                       </div>

                   </div> <!-- storage_location -->

               </div> <!-- storage_type -->

       </div> <!-- storage_modal container -->

    </div> <!-- settlement sheet Storage tab ENDS here -->


    <!-- ADMIN tab! -->

    <div
        id="settlementSheetAdminTab"
        class="view_tab"
        ng-show='tabsObject.activeTab === 6'
        ng-controller='settlementSheetAdminTabController'
        ng-init="
            loadSettlementMacros();
        "
    >
        <div
            class="kd worksheet_block"
        >

            <div class="kd worksheet_block_title">
                Version
            </div>

            <p>
                Change the version of <i>Monster</i> game assets and rules that
                are used by this settlement.
            </p>
            <p
                ng-if="
                    user.user.preferences.show_ui_tips
                "
            >
                Changing this <b>will not</b> alter settlement or survivor data!
            </p>
            <select
                class="kd_kickstarter_select"
                ng-disabled="
                    user.user.subscriber.level < 2
                    && user.user.preferences.beta !== true
                "
                ng-model="settlement.sheet.version"
                ng-options="
                    version.handle as version.version + ' - ' + version.released_summary for version in settlement.game_assets.versions
                "
                ng-change="setVersion()"
                ng-selected="settlement.sheet.version"
            >
            </select>

        </div> <!-- set version -->


        <!-- MACROS -->
        <div
            class="kd worksheet_block"
            ng-if="settlementMacros"
            ng-class="{
                'disabled': user.user.subscriber.level === 0,
                'disabled': !user.user.preferences.beta,
            }"
            ng-disabled="user.user.subscriber.level < 2"
        >

            <div class="kd worksheet_block_title">
                Macros (&beta;)
            </div>

            <p>
                Settlement sheet macros allow you to perform complex settlement
                updates automatically! Tap or click a macro below to review the
                operations it performs.
            </p>

            <div
                ng-repeat="macro in settlementMacros"
                ng-init="macroControlsId = macro.handle + 'ControlsDiv'"
            >
                <button 
                    class="clickable kd capsule yellow full_width"
                    ng-click="ngShow(macroControlsId)"
                >
                    {{macro.name}}
                </button>

                <div
                    id="{{macroControlsId}}"
                    class="hidden modal"
                    ng-click="ngHide(macroControlsId)"
                >

                    <div
                        class="modal-content settlement_sheet_macro"
                        ng-click="$event.stopPropagation()"
                    >

                        <div
                            class="clickable corner_close_modal"
                            ng-click="ngHide(macroControlsId)"
                        >
                        </div>

                        <h3 class="kd title">{{macro.name}}</h3>

                        <p ng-bind-html="macro.desc|trustedHTML"></p>

                        <div
                            class="kd worksheet_block"
                        >
                            <div
                                ng-repeat="item in macro.summary"
                                class="kd worksheet_row"
                            >
                                <div class="kd checkbox checked"></div>
                                <div
                                    class="kd checkbox_desc"
                                    ng-bind-html="item|trustedHTML"
                                >
                                </div>
                            </div>
                        </div>

                        <div
                            class="kd rulebook_warning pink"
                            ng-if="macro.new_settlement"
                        >
                            This macro was intended to be applied to new
                            settlements at creation time! Apply this macro
                            at your own risk...
                        </div>

                        <div class="modal_content_button_raft">
                            <button
                                class="kd capsule full_width blue"
                                ng-click="
                                    ngHide(macroControlsId);
                                    applyMacro(macro.handle);
                                "
                            >
                                Apply macro
                            </button>
                            <button
                                class="kd capsule full_width "
                                ng-click="ngHide(macroControlsId)"
                            >
                                Close
                            </button>
                        </div>

                    </div>
                </div>

            </div>

        </div> <!-- MACROS -->


        <!-- ABANDON -->
        <div
            class="kd worksheet_block"
        >

            <div class="kd worksheet_block_title">
                Abandon Settlement
            </div>

            <p
                ng-if="settlement.sheet.abandoned !== undefined"
            >
                Use the button below to remove the 'abandoned' status from
                <b>{{settlement.sheet.name}}</b>; this will cause it to appear
                on your dashboard and function normally again.
            </p>
            <p
                ng-if="settlement.sheet.abandoned === undefined"
            >
                Use the button below to mark <b>{{settlement.sheet.name}}</b>
                as "Abandoned" and prevent it from showing up on your
                KDM-Manager dashboard.
            </p>
            <p
                ng-if="settlement.sheet.abandoned === undefined"
            >
                Abandoning a settlement <i>does not</i> remove it from the
                system. Abandoned settlements <i>may</i> be accessed and
                updated normally.
            </p>

            <button
                class="kd capsule full_width pink"
                ng-click="abandonSettlement()"
                ng-if="settlement.sheet.abandoned === undefined"
            >
                Abandon Settlement
            </button>

            <button
                class="kd capsule full_width pink"
                ng-click="abandonSettlement('UNSET')"
                ng-if="settlement.sheet.abandoned !== undefined"
            >
                Un-abandon Settlement
            </button>

        </div> <!-- abandon controls -->

        <!-- REMOVE -->
        <div
            class="kd worksheet_block"
            ng-if="user.user.preferences.show_remove_button == true"
        >
            <div class="kd worksheet_block_title kd_red_text">
                Delete Settlement
            </div>

            <p>
                Use the button below to permanently delete
                <b>{{settlement.sheet.name}}</b>.
            </p>
            <p>
                This will <b>permanently delete all survivors</b> associated
                with this settlement.
            </p>
            <p class="kd_red_text">
                &nbsp; 
                <b>This cannot be undone.</b>
            </p>
            <button
                class="kd capsule full_width pink"
                ng-click="showHide('removeSettlementConfirmation')"
            >
                Delete Settlement
            </button>
        </div>

        <div
            id="removeSettlementConfirmation"
            class="modal-black hidden"
            ng-click="ngHide('removeSettlementConfirmation')"
        >
            <div
                class="modal-content rm_asset_confirm_container kd_red"
                ng-click="$event.stopPropagation()"
            >

                <h3>DELETE SETTLEMENT</h3>

                <p>
                    This CANNOT BE UNDONE and is not the same as marking the
                    settlement "abandoned".
                </p>
                <p>
                    Please consider abandoning old settlements rather than
                    deleting them. This allows data about the settlement to
                    be used in general https://kdm-manager.com stats that
                    all users see on their dashboards.
                </p>
                <p>
                    If you still want to permanently delete
                    <b>{{settlement.sheet.name}}</b>, type "DELETE" (without
                    the quotes) in the box below and then click the "DELETE"
                    button that appears to permanently delete this settlement
                    AND ALL SURVIVORS WHO BELONG TO THIS SETTLEMENT forever.
                </p>

                <input
                    type="text"
                    class="confirm_remove"
                    ng-model="scratch.confirmRemove"
                    placeholder="DELETE"
                />

                <button
                    class="ng_fade kd_kickstarter_button kd_pink"
                    ng-if="scratch.confirmRemove === 'DELETE'"
                    onClick="showFullPageLoader()"
                    ng-click="
                        showHide('removeSettlementConfirmation');
                        removeSettlement();
                        postForm('change_view','dashboard');
                    "
                >
                    Delete Settlement
                </button>
                <button 
                    class="ng_fade kd_kickstarter_button"
                    ng-if="scratch.confirmRemove !== 'DELETE'"
                    ng-click="ngHide('removeSettlementConfirmation')"
                >
                    Close
                </button>
            </div><!-- rm_settlement_confirm_container -->

        </div><!-- modal-black confirmation container-->

    </div> <!-- settlementSheetAdminTab -->


</div> <!-- settlementSheetApp -->
    
