<!-- top nav - DEPRECATED -->
<div
    id="topNavBar"
    class="survivor_sheet_gradient"
    style='{{settlement.survivor_color_schemes[survivor.sheet.color_scheme].style_string}}'
>
    <button
        id="floatingRefreshButton"
        class="clickable kd_yellow font_large circular_button"
        ng-if="settlement.sheet !== undefined"
        ng-click="
            showFullPageLoader();
        	initializeSettlement('survivorSheet', '$api_url','$settlement_id');
	        initializeSurvivor('$survivor_id');
        "
    >
        &#8634;
    </button>
</div>

<script
	src="/js/survivorSheet.js?v=$application_version"
    ng-init="
        setSessionVars('$user_login','$current_session');
        initializeSettlement('survivorSheet', '$api_url','$settlement_id');
        initializeSurvivor('$survivor_id');
	"
>
</script>


<div
    id="survivorSheetApp"
    ng-controller="survivorSheetController"
	ng-if="survivor !== undefined"
	ng-init="
		initializeUser('$user_id');
		initializeScope();
	"
>

    <!-- tabs; this lays anywhere depending on CSS -->
    <div
        id="viewTabContainer"
        ng-if="survivor.sheet !== undefined"
    >

        <div
            ng-repeat="tab in tabsObject.tabs"
            id="{{'survivorViewTabButton-' + tab.id}}"
            class="view_tab_button"
            ng-class="{'active': tabsObject.activeTab === tab.id}"
            ng-click="changeTab(tab.id);"
            ng-if="tab.debug !== true || NGDEBUG"
        >
            {{tab.name}}
        </div>

    </div>

    <!-- 'Sheet' tab starts here -->

    <div
        id="survivorViewSheetTab"
        class="view_tab"
        ng-show="
            tabsObject.activeTab === 0 &&
            survivor.sheet !== undefined
        "
    >

        <div
	    	id="survivorSheetLeftColumn"
    	>

            <div
                id="survivorName"
                contentEditable="true"
                class="survivor_sheet_survivor_name"
                ng-click="ngRolledUp['nameControl'] === false || rollUp('nameControl')"
                placeholder="Name"
            >
                {{survivor.sheet.name}}
            </div>


        <div
            id="nameControl"
            class="kd_sheet_ui_roll_down rolled_up"
            ng-controller="survivorNameController"
        >
            <div class="kd_sheet_ui_roll_down_controls">
                <div class="kd_sheet_ui_number_tumbler">
                    <button
                        class="kd_kickstarter_button kd_pink"
                        ng-if="user.user.subscriber.level > 1"
                        ng-click="randomName()"
                    >
                        Random Name
                    </button>
                    <button
                        class="kd_kickstarter_button kd_pink"
                        ng-if="
                            user.user.subscriber.level > 1 &&
                            survivor.sheet.name
                        "
                        ng-click="randomSurname()"
                    >
                        Random Surname
                    </button>
                    <button
                        class="kd_kickstarter_button kd_blue"
                        ng-click="setSurvivorName();"
                    >
                        Save Changes
                    </button>
					<button
						class="kd_kickstarter_button"
						ng-click="
							rollUp('nameControl');
							survivor.sheet.name = scratch.originalName;
						"
					>
						<span ng-if="survivor.sheet.name === scratch.originalName">
							Close
						</span>
						<span ng-if="survivor.sheet.name !== scratch.originalName">
							Undo
						</span>
					</button>
					
                </div> <!-- number tumbler -->
            </div>
        </div> <!-- nameControl -->
        <!-- survivor name controls end here -->


        <!--

            controls for sex, avatar 

        -->

        <div
            ng-if="survivor.sheet != undefined"
            class="survivor_sheet_kd_sheet_ui_box survivor_sex_box"
        >
            <div class="survivor_sheet_avatar_container">
                <label
                    for="avatar_file_input"
                    ng-if="survivor.sheet.avatar != undefined"
                >
                    <img
                        class="survivor_avatar_image"
                        ng-src="{{api_url}}avatar/get/{{survivor.sheet.avatar.$oid}}"
                        alt="Click to change the avatar image for {{survivor.sheet.name}}"
                    />
                </label>
                <label
                    for="avatar_file_input"
                    ng-if="survivor.sheet.avatar == undefined"
                >
                    <img
                        class="survivor_avatar_image"
                        ng-src="/media/default_avatar_{{survivor.sheet.effective_sex}}.png"
                        alt="Click to change the avatar image for {{survivor.sheet.name}}"
                    />
                </label>
                <input
                    id="avatar_file_input"
                    ng-controller='avatarController'
                    ng-model="scratch.newAvatar"
                    ng-blur="setAvatar()"
                    class="hidden"
                    type="file"
                    name="survivor_avatar"
                    accept="image/*"
                    custom-on-change="setAvatar"
                />

            </div> <!-- survivor_sheet_avatar_container -->

            <div
                class="survivor_sex_toggle clickable"
                ng-click="toggleSurvivorSex()"
                ng-if="survivor.sheet.sex == survivor.sheet.effective_sex"
            >
                M <div class="kd_sheet_ui_box" ng-class="{checked: survivor.sheet.sex == 'M'}"></div>
                F <div class="kd_sheet_ui_box" ng-class="{checked: survivor.sheet.sex == 'F'}"></div>
            </div>
            <div
                class="survivor_sex_toggle clickable"
                ng-if="survivor.sheet.sex != survivor.sheet.effective_sex"
                ng-click="rollUp('effectiveSexWarning')"
            >

                M <div
                    class="kd_sheet_ui_box"
                    ng-class="{kd_red_box: survivor.sheet.effective_sex == 'M',}"
                >
                </div>

                F <div
                    class="kd_sheet_ui_box"
                    ng-class="{kd_red_box: survivor.sheet.effective_sex == 'F',}"
                >
                </div>

            </div>
        </div> <!-- survivor_sex_box -->

        <div
            id="effectiveSexWarning"
            class="kd_sheet_ui_roll_down rolled_up clickable"
            ng-click="rollUp('effectiveSexWarning')"
        >
            <div class="kd_sheet_ui_roll_down_controls">
                <div class="kd_sheet_ui_row_tip">
                    {{survivor.sheet.name}}'s base sex attribute is <b>{{survivor.sheet.sex}}</b>, but their sex haschanged to <b>{{survivor.sheet.effective_sex}}</b> due the effects of a cursed item!</br>
                    In order to edit this survivor's sex, you must first remove the cursed item that changed their sex to <b>{{survivor.sheet.effective_sex}}</b>.<br/>
                    <i>Click or tap here to hide this notification.</i>
                </div>
            </div>
        </div>

        <!-- end of sex, avatar controls -->


        <!-- affinities opener -->
        <div
            ng-if="survivor.sheet !== undefined"
            class="
                clickable
                survivor_sheet_kd_sheet_ui_box
                affinities_opener
            "
            ng-click="ngShow('modalAffinity')"
            title="Permanent affinity bonuses for {{survivor.sheet.name}}. Click or tap to edit!"
        >
            <div
                class="font_large affinity_{{a}} affinity_span"
                ng-repeat="a in ['red','green','blue']"
            >
                {{survivor.sheet.affinities[a]}}
            </div>
        </div> <!-- affinities opener -->


        <div
            id="settlementSheetSurvivalContainer"
            class="survivor_sheet_kd_sheet_ui_box border"
            title="Survival controls and info for {{survivor.sheet.name}}! Click or tap to modify."
            ng-class="{
                'rolled_down': ngRolledUp['survivalControl'] === false,
            }"
        >

            <div
                class="survival_box_number_container clickable"
                ng-click="rollUp('survivalControl')"
            />
                <input
                    disabled
                    class="survivor_sheet survival_box_number"
                    type="number"
                    ng-model="survivor.sheet.survival"
                    min="0"
                />
            </div>

            <div class="survival_box_title_and_lock">
                <div
                    class="font_large survival_box_title clickable"
                    ng-click="rollUp('survivalControl')"
                >
                    Survival
                </div>
                <div
                    class="survival_box_lock clickable"
                    ng-click="toggleStatusFlag('cannot_spend_survival')"
                >
                    <div
                        class="kd_sheet_ui_box"
                        ng-class="{
                            'checked': survivor.sheet.cannot_spend_survival,
                        }"
                    >
                    </div>
                    <div class="font_small">
                        &#x1f512; Cannot spend survival.
                    </div>
                </div>
            </div>

            <div class="survival_box_survival_actions_container">
                <div
                    class="help-tip survival_box_survival_action_item"
                    ng-repeat="sa in survivor.survival_actions"
                >
                    <div
                        class="kd_sheet_ui_box small"
                        ng-class="{checked: sa.available == true}"
                    >
                    </div>
                    <span class="font_small sa_name">{{sa.name}}</span>
                    <p>{{sa.title_tip}}</p>
                </div>
            </div>

        </div> <!-- survival controller ends here for JS! -->

        <div
            id="survivalControl"
            class="kd_sheet_ui_roll_down rolled_up"
        >
            <div class="kd_sheet_ui_roll_down_controls integrated">
                <div
                    class="kd_sheet_ui_row_tip"
                    ng-if="settlement.sheet.enforce_survival_limit == true"
                >
                    {{settlement.sheet.name}} Survival Limit is <b>{{settlement.sheet.survival_limit}}</b>!
                </div>
                <div class="kd_sheet_ui_number_tumbler">
                    <button
                        class="kd_kickstarter_button"
                        ng-disabled="survivor.sheet.can_gain_survival === false"
                        ng-click="
                            survivor.sheet.survival = survivor.sheet.survival + 1
                        "
                    >
                        &#x25B2;
                    </button>
                    <button
                        class="kd_kickstarter_button"
                        ng-disabled="survivor.sheet.survival < 1"
                        ng-click="
                            survivor.sheet.survival = survivor.sheet.survival - 1
                        "
                    >
                        &#x25BC;
                    </button>
                    <button
                        class="kd_kickstarter_button kd_blue"
                        ng-click="
                            updateSurvival();
                            rollUp('survivalControl');
                        "
                    >
                        Save & Close
                    </button>
                </div> <!-- number tumbler -->
            </div>
        </div> <!-- survival controls and rolls -->
        
        <!-- SOTF opl -->
        <div
            class="clickable survivor_sheet_kd_sheet_ui_box border"
            ng-if="
                settlement != undefined &&
                settlement.sheet.principles.indexOf('survival_of_the_fittest') != -1
            "
            ng-click="sotfToggle()"
            ng-class="{kd_red_border: survivor.sheet.sotf_reroll === true}"
        >
            <div
                class="kd_sheet_ui_box_row sotf_option"
            >
                <div
                    class="kd_sheet_ui_box"
                    ng-class="{
                        'kd_red_box': survivor.sheet.sotf_reroll === true
                    }"
                >
                </div>

                <div
                    class="font_medium"
                    ng-class="{
                        'kd_red_text': survivor.sheet.sotf_reroll === true
                    }"
                >
                    Once per lifetime reroll
                </div>
            </div>

            <div
                class="font_small kd_sheet_ui_box_row sotf_caption"
                ng-if="survivor.sheet.sotf_reroll != true"
            >
                <p class="font_small">
                    <b>Survival of the fittest:</b> Once per lifetime, a survivor may
                    reroll a single roll result. They must keep this result.</b>
                </p>
            </div>
        </div> <!-- sotf reroll -->

        <!-- ATTRIBUTES -->

	    <div
	        class="attributes_container survivor_sheet"
    	>
	        <div
	            ng-repeat="A in ['Movement','Accuracy','Strength','Evasion','Luck','Speed']"
            	ng-class="{last: $last}"
        	    ng-click="rollUp(A + 'AttributeControlBox')"
    	        class="attribute_box clickable {{A}}"
	        >
	            <input
                    disabled
    	            class="attribute_box_number"
        	        type="number"
	                ng-value="
						survivor.sheet[A] +
						survivor.sheet.attribute_detail[A].tokens +
						survivor.sheet.attribute_detail[A].gear
					"
	                ng-class="{
	                    'maroon_text':
							survivor.sheet[A] +
							survivor.sheet.attribute_detail[A].tokens +
							survivor.sheet.attribute_detail[A].gear < survivor.sheet[A]
						,
	                    'green_text':
							survivor.sheet[A] +
							survivor.sheet.attribute_detail[A].tokens +
							survivor.sheet.attribute_detail[A].gear > survivor.sheet[A],
	                };"
	            />
                <span class="font_small">
    	            {{A}}
                </span>
	        </div> <!-- attributes repeater -->
	    </div> <!-- attributes container -->

		<!-- controllers repeat here -->

        <div
	        ng-repeat="A in ['Movement','Accuracy','Strength','Evasion','Luck','Speed']"
			id="{{A}}AttributeControlBox"
            class="kd_sheet_ui_roll_down border rolled_up"
        >
            <div
                class="
                    kd_sheet_ui_roll_down_controls
                    quickview_attribute_tumblers_container {{A}}
                "
            >

                <div class="vertical_tumbler_container">
                    Base
                    <button ng-click="survivor.sheet[A] = survivor.sheet[A] + 1">
                        &#x25B2;
                    </button>
					<input type="number" ng-model="survivor.sheet[A]" />
                    <button ng-click="survivor.sheet[A] = survivor.sheet[A] - 1">
                        &#x25BC;
					</button>
                </div>

		        <div class="vertical_tumbler_container">
		            Gear
		            <button
		                ng-click="
		                    survivor.sheet.attribute_detail[A].gear = survivor.sheet.attribute_detail[A].gear + 1
		                "
		            >
	        	        &#x25B2;
    		        </button>
		            <input type="number" ng-model="survivor.sheet.attribute_detail[A].gear" />
		            <button ng-click="survivor.sheet.attribute_detail[A].gear = survivor.sheet.attribute_detail[A].gear - 1">
		                &#x25BC;
		            </button>
		        </div>

		        <div class="vertical_tumbler_container">
		            Tokens
		            <button ng-click="survivor.sheet.attribute_detail[A].tokens = survivor.sheet.attribute_detail[A].tokens + 1">
		                &#x25B2;
		            </button>
		            <input type="number" ng-model="survivor.sheet.attribute_detail[A].tokens" />
		            <button ng-click="survivor.sheet.attribute_detail[A].tokens = survivor.sheet.attribute_detail[A].tokens - 1">
		                &#x25BC;
		            </button>
		        </div>
		    </div>

		    <button
		        class="kd_kickstarter_button kd_blue"
		        ng-click="
		            rollUp(A + 'AttributeControlBox');
		            setSurvivorPrimaryAttributes(survivor, A)
		        "
		    >
		        Save {{A}}
			</button>

		</div> <!-- attrib_list repeater -->

        <!-- attributes end ; BRAIN hit box starts here -->

        <div
			class="hitbox_container brain"
			ng-class="{'insane': survivor.sheet.Insanity >= 3}"
		>

            <div
                class="clickable font_large hitbox_shield_container brain"
                ng-click="rollUp('insanityHitBoxControl')"
            >

                <input
                    disabled
                    id="insanityBox"
                    type="number"
                    class="survivor_sheet_hitbox hitbox_shield brain"
                    name="Insanity"
                    min="0"
                    ng-model="survivor.sheet.Insanity"
					ng-class="{'insane': survivor.sheet.Insanity >= 3}"
                />

                <span class="font_small">
                    Insanity
                </span>

            </div>

            <div
                class="clickable hitbox_detail brain"
                ng-click="rollUp('insanityHitBoxControl')"
            >
                <div class="title">Brain</div>
                <div
                    class="font_small tip"
					ng-class="{'insane': survivor.sheet.Insanity >= 3}"
                >
                    If your insanity is 3+, you are <b>insane</b>.
                </div>
            </div>

            <div class="hitbox_boxes_container brain">
                <div
                    class="clickable damage_box"
                    ng-class="{
                        'checked': survivor.sheet.brain_damage_light !== undefined,
                        'kd_red_box': survivor.sheet.brain_damage_light && survivor.sheet.Insanity >= 3,
                    }"
                    ng-click="toggleDamage('brain_damage_light');"
                 /></div>
            </div>

        </div><!-- brain display container -->

        <div
           id="insanityHitBoxControl"
           class="kd_sheet_ui_roll_down rolled_up"
        >
            <div
                class="kd_sheet_ui_roll_down_controls integrated"
		        ng-class="{'insane': survivor.sheet.Insanity >= 3}"
            >
               <div class="kd_sheet_ui_number_tumbler">
                    <button
                        class="kd_kickstarter_button"
                        ng-click="survivor.sheet.Insanity = survivor.sheet.Insanity + 1"
                    >
                        &#x25B2;
                    </button>
                    <button
                        class="kd_kickstarter_button"
                        ng-click="survivor.sheet.Insanity = survivor.sheet.Insanity - 1"
                    >
                        &#x25BC;
                    </button>
					<button
                        class="kd_kickstarter_button kd_blue"
                    	ng-click="
							updateAttrib('Insanity');
							rollUp('insanityHitBoxControl')
						"
                    >
						Save & Close
                    </button>
               </div> <!-- number tumbler -->
           </div>
        </div>


		<!-- bleeding tokens! -->
        <div
            class="hitbox_container"
            title="Bleeding Tokens"
        >
            <div
                class="clickable bleeding_token_container"
                ng-click="rollUp('bleedingTokensControls')"
            >
                <div
                    ng-repeat="token_value in [1,2,3,4,5]"
                    class="kd bleeding_token"
                    ng-class="{
                        'active': token_value <= survivor.sheet.bleeding_tokens,
                    }"
                >
                </div>
                <div
                    ng-if="survivor.sheet.bleeding_tokens >= token_value"
                    ng-repeat="token_value in [6,7]"
                    class="ng_fade kd bleeding_token active"
                >
                </div>
            </div>
        </div>
        <div
            id='bleedingTokensControls'
            class="kd_sheet_ui_roll_down rolled_up"
        >
            <div class="kd_sheet_ui_roll_down_controls">
                <div class="kd_sheet_ui_number_tumbler">
                    <button
                        ng-disabled="survivor.sheet.bleeding_tokens === 7"
                        class="kd_kickstarter_button"
                        ng-click="survivor.sheet.bleeding_tokens = survivor.sheet.bleeding_tokens + 1"
                    >
                        &#x25B2;
                    </button>
                    <button
                        ng-disabled="s.sheet.bleeding_tokens === 0"
                        class="kd_kickstarter_button"
                        ng-click="survivor.sheet.bleeding_tokens = survivor.sheet.bleeding_tokens - 1"
                    >
                        &#x25BC;
                    </button>
                    <button
                        class="kd_kickstarter_button kd_blue"
                        ng-click="
                            setBleedingTokens(survivor);
                            rollUp('bleedingTokensControls')
                        "
                    >
                        Save Bleeding Tokens
                    </button>
                </div> <!-- number tumbler -->
            </div><!-- roll_down_controls -->
        </div><!-- roll_down container + loc box ID -->
        <!-- bleeding tokens -->



        <!-- HIT LOCATIONS -->
        <div
            class="hit_location_repeater"
            ng-repeat="location in [
                {name: 'Head', glyph: 'b', dmg: ['heavy']},
                {name: 'Arms', glyph: 'd', dmg: ['light', 'heavy']},
                {name: 'Body', glyph: 'c', dmg: ['light', 'heavy']},
                {name: 'Waist', glyph: 'e', dmg: ['light', 'heavy']},
                {name: 'Legs', glyph: 'f', dmg: ['light', 'heavy']},
            ]"
            ng-init="ctrlBoxID = location.name.toLowerCase() + 'Box' + sheetOID;"
        >
            <div
                class="hitbox_container"
            >
                <div
                    class="font_large hitbox_shield_container clickable"
                    ng-click="rollUp(ctrlBoxID)"
                >
                    <input
                    ng-click="rollUp(ctrlBoxID)"
                        disabled
                        class="survivor_sheet_hitbox hitbox_shield"
                        type="number"
                        min="0"
                        ng-model="survivor.sheet[location.name]"
                    />
                </div>

                <div
                    class="clickable hitbox_detail"
                    ng-click="rollUp(ctrlBoxID)"
                >
                    <div class="title">
                        <font class="kdm_font_hit_locations">
                            {{location.glyph}}
                        </font>
                        {{location.name}}
                    </div>
                    <div class="font_small tip">
                        &#9632; Heavy Injury: Knocked Down.
                    </div>
                </div>

                <div class="hitbox_boxes_container">
                    <div
                        ng-repeat="dmgType in location.dmg"
                        ng-init="toggleName = location.name.toLowerCase() + '_damage_' + dmgType"
                        ng-class="
                            {checked: survivor.sheet[toggleName] !== undefined}
                       "
                        ng-click="toggleDamage(toggleName);"
                        class="clickable damage_box {{dmgType}}"
                     />
                     </div>
                </div>

			</div> <!-- hitbox container -->

            <div
                id="{{ctrlBoxID}}"
                class="kd_sheet_ui_roll_down rolled_up"
            >
                <div class="kd_sheet_ui_roll_down_controls">
                    <div class="kd_sheet_ui_number_tumbler">
                        <button
                            class="kd_kickstarter_button"
                            ng-click="survivor.sheet[location.name] = survivor.sheet[location.name] + 1"
                        >
                            &#x25B2;
                        </button>
                        <button
                            class="kd_kickstarter_button"
							ng-disabled="survivor.sheet[location.name] < 1"
                            ng-click="survivor.sheet[location.name] = survivor.sheet[location.name] - 1"
                        >
                            &#x25BC;
                        </button>
                        <button
                            class="kd_kickstarter_button kd_blue"
                            ng-click="
                        		updateAttrib(location.name);
                                rollUp(ctrlBoxID)
                            "
                        >
                            Save & Close
                        </button>
                    </div> <!-- number tumbler -->
                </div><!-- roll_down_controls -->
            </div><!-- roll_down container + loc box ID -->

		</div> <!-- hit location repeater -->

    </div> <!-- HIT BOXES END HERE -->



<!-- middle column starts! -->

    <div id="survivorSheetMiddleColumn" ng-if="survivor != undefined">

        <!-- favorite / retired / dead -->
        <div
            ng-if="survivor.sheet !== undefined"
            class="survivor_sheet_kd_sheet_ui_box border ui_tiles_box"
            ng-class="{
                'rolled_down': ngRolledUp['controlsOfDeath'] === false,
            }"
        >
            <div
                class="clickable"
                ng-click="toggleFavorite()"
            >
                <span
                    class="ng_fade favorite_star"
                    ng-class="{
                        'checked': scratch.favoriteBox === true,
                    }"
                >
                </span>
                Favorite
            </div>

            <div
                class="clickable"
                ng-click="setRetired()"
            >
                <div
                    class="kd_sheet_ui_box"
                    ng-class="{checked: survivor.sheet.retired == true}"
                >
                </div>
                Retired
            </div>

            <div
                class="clickable"
                ng-click="rollUp('controlsOfDeath')"
                ng-class="{
                    'kd_red_text': survivor.sheet.dead !== undefined,
                }"
                title="Tap or click to set cause of death."
            >

                <div
                    class="kd_sheet_ui_box"
                    ng-class="{kd_red_box: survivor.sheet.dead !== undefined}"
                >
                </div>

                Dead
            </div>

        </div> <!-- survivor_dead_retired_container -->

        <!-- inline controls of death -->
        <div
            id="controlsOfDeath"
            class="kd_sheet_ui_roll_down rolled_up"
            ng-if="survivor.sheet !== undefined"
            ng-controller="controlsOfDeathController"
        >
            <div
                class="kd_sheet_ui_roll_down_controls integrated"
                ng-if="ngRolledUp['controlsOfDeath'] === false"
            >

                <div
                    class="kd_sheet_ui_number_tumbler"
                >

                    <select
                        class="kd_kickstarter_select"
                        ng-init="initCODlist();"
                        ng-model="survivor.sheet.cause_of_death"
                        ng-options="c.name as c.name disable when c.disabled for c in settlement.game_assets.causes_of_death"
                        ng-change="processSelectCOD()"
                        ng-selected='survivor.sheet.cause_of_death'
                    >
                        <option disabled value="">Choose Cause of Death</option>
                    </select>
            
                    <input
                        id = "customCODinput"
                        type="text"
                        class="ng_fade kd_red_border kd_red_text custom_cod_text"
                        placeholder="Enter custom cause of death"
                        name="enter_cause_of_death"
                        ng-if="ngVisible['customCODinput']"
                        ng-value="survivor.sheet.cause_of_death"
                        ng-model="scratch.customCOD"
                    />

                    <div
                        id="customCODwarning"
                        class="ng_fade font_medium hidden kd_red_text"
                    >
                        Please enter a cause of death!
                    </div>

                    <button
                        class="kd_kickstarter_button kd_pink"
                        ng-if="ngVisible['customCODinput']"
                        ng-click="submitCOD(scratch.customCOD)"
                        ng-disabled="scratch.customCOD === null || scratch.customCOD === undefined"
                    >
                        Die
                    </button>

                    <button
                        class="ng_fade kd_kickstarter_button kd_blue"
                        ng-if="survivor.sheet.dead === true"
                        ng-click="resurrect()"
                    >
                        Resurrect {{survivor.sheet.name}}
                    </button>

                    <button
                        class="kd_kickstarter_button"
                        ng-click="rollUp('controlsOfDeath')"
                    >
                        Close
                    </button>
    
                </div> <!-- kd_sheet_ui_number_tumbler -->
            </div>
        </div>
        <!-- inline controls of death end here -->


        <!-- 

            campaign attributes

        -->

        <div
            class="
                survivor_sheet_kd_sheet_ui_box border ui_tiles_box
                survivor_sheet_campaign_attributes_container
            "
            title="Campaign-specific attributes!"
        >

            <div
                class="clickable"
                ng-click="ngShow('cursedItemsController')"
                ng-if="survivor.sheet !== undefined"
            >
                <div
                    class="kd_sheet_ui_box"
                    ng-class="{
                        'checked': survivor.sheet.cursed_items.length > 0,
                    }"
                >
                </div>
                Cursed Items ({{survivor.sheet.cursed_items.length}})
            </div>

            <div
                class="clickable"
                ng-if="settlement.game_assets.campaign.saviors === true"
                ng-click="ngShow('modalSavior')"
            >
                <div
                    class="kd_sheet_ui_box affinity_{{survivor.sheet.savior}}"
                >
                </div>
                Savior
            </div>

        </div> <!-- campaign attributes container-->


        <!--

                Survivor Sheet secondary attribs (right col) start here!

        -->

        <div class="survivor_sheet_secondary_attribs_container">

            <!-- HUNT XP -->
            <div
                class="survivor_sheet_kd_sheet_ui_box border clickable"
                ng-click="rollUp('huntXPControl')"
                ng-class="{
                    'rolled_down': ngRolledUp['huntXPControl'] === false,
                }"
                title="Hunt XP for {{survivor.sheet.name}}. Tap or click to edit!"
            >
                <div class="kd_sheet_ui_box_row hunt_xp">
                    <span class="title">Hunt XP</span>
                    <div class="hunt_xp_box_container">
                        <span
                            ng-repeat="value in [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]"
                            class="kd_sheet_ui_box"
                            ng-class="{
                                'checked': survivor.sheet.hunt_xp >= value,
                                'heavy': [2,6,10,15,16].includes(value),
                                'dotted': value === 16,
                            }"
                        ></span>
                    </div>
                </div>
            </div> <!-- HUNT XP -->

            <div
                id="huntXPControl"
                class="kd_sheet_ui_roll_down rolled_up"
            >
                <div
                    class="kd_sheet_ui_roll_down_controls integrated"
                    ng-if="ngRolledUp['huntXPControl'] === false"
                >

                    <div class="kd_sheet_ui_row dynamic_tip wrap">

                        <div class="font_small dynamic_tip_container">
                            <div
                                class="kd_sheet_ui_box small"
                                ng-repeat="value in [2]"
                                ng-class="{'checked': survivor.sheet.hunt_xp >= value}"
                            >
                            </div>
                            <font class="kdm_font">g</font>
                            Age
                        </div>

                        <div class="font_small dynamic_tip_container">
                            <div
                                class="kd_sheet_ui_box small"
                                ng-repeat="value in [2,6]"
                                ng-class="{'checked': survivor.sheet.hunt_xp >= value}"
                            >
                            </div>
                            <font class="kdm_font">g</font> Age
                        </div>

                        <div class="font_small dynamic_tip_container">
                            <div
                                class="kd_sheet_ui_box small"
                                ng-repeat="value in [2,6,10]"
                                ng-class="{'checked': survivor.sheet.hunt_xp >= value}"
                            >
                            </div>
                            <font class="kdm_font">g</font> Age
                        </div>

                        <div class="font_small dynamic_tip_container">
                            <div
                                class="kd_sheet_ui_box small"
                                ng-repeat="value in [2,6,10,15]"
                                ng-class="{'checked': survivor.sheet.hunt_xp >= value}"
                            >
                            </div>
                            <font class="kdm_font">g</font> Age
                        </div>

                        <div class="dynamic_tip_container">
                            <div class="kd_sheet_ui_box small dotted"></div>
                            Retired
                        </div>

                </div><!-- dynamic tip row -->

                <div class="kd_sheet_ui_number_tumbler">
                    <button
                        class="kd_kickstarter_button"
                        ng-click="
                            survivor.sheet.hunt_xp = survivor.sheet.hunt_xp + 1
                        "
                    >
                        &#x25B2;
                    </button>
                    <button
                        class="kd_kickstarter_button"
                        ng-click="
                            survivor.sheet.hunt_xp = survivor.sheet.hunt_xp - 1
                        "
                    >
                        &#x25BC;
                    </button>
                    <button
                        class="kd_kickstarter_button kd_blue"
                        ng-click="
                            updateAttrib('hunt_xp');
                            rollUp('huntXPControl')
                        "
                    >
                        Save & Close
                    </button>
                </div> <!-- number tumbler -->
            </div>
        </div>

        <!-- end of Hunt XP controls!-->

        <!-- WEAPON PROFICIENCY -->
        <div
            class="survivor_sheet_kd_sheet_ui_box border clickable"
            ng-click="rollUp('weaponProficiencyControl')"
            ng-class="{
                'rolled_down': ngRolledUp['weaponProficiencyControl'] === false,
            }"
            title="Weapon Proficiency info for {{survivor.sheet.name}}. Tap or click to edit!"
        >
            <div class="kd_sheet_ui_row">
                <div class="title">
                Weapon Proficiency
                </div>
                <div class="kd_sheet_ui_box_row long">
                    <span
                        class="kd_sheet_ui_box"
                        ng-repeat="value in [0,1,2,3,4,5,6,7,8]"
                        ng-class="{
                            'checked': survivor.sheet['Weapon Proficiency'] > value,
                            'heavy': [2,8].indexOf(value) !== -1,
                        }"
                    ></span>
                </div>
            </div>
            <div
                class="kd_sheet_ui_row"
                ng-if="survivor.sheet.weapon_proficiency_type !== null"
            >
                <div>
                    <b>Type:&nbsp;</b> {{settlement.game_assets.weapon_proficiency_types[survivor.sheet.weapon_proficiency_type].name}}
                </div>
            </div>
        </div> <!-- survivor_sheet_kd_sheet_ui_box -->
        <div
            id="weaponProficiencyControl"
            class="kd_sheet_ui_roll_down rolled_up"
        >
          <div class="kd_sheet_ui_roll_down_controls integrated">
                <div class="kd_sheet_ui_row dynamic_tip">
                    <div class="dynamic_tip_container">
                        <span
                            class="kd_sheet_ui_box small"
                            ng-class="{checked: survivor.sheet['Weapon Proficiency'] > 2}"
                        ></span>
                        <b>Specialist</b>
                    </div>
                    <div class="dynamic_tip_container">
                        <span
                            ng-repeat="box in [1,2]"
                            class="kd_sheet_ui_box small"
                            ng-class="{checked: survivor.sheet['Weapon Proficiency'] > 7}"
                        ></span>
                        <b>Master</b>
                    </div>
                </div>
                <div class="kd_sheet_ui_number_tumbler">
                    <button
                        class="kd_kickstarter_button"
                        ng-click="
                            survivor.sheet['Weapon Proficiency'] = survivor.sheet['Weapon Proficiency'] + 1
                        "
                    >
                        &#x25B2;
                    </button>
                    <button
                        class="kd_kickstarter_button"
                        ng-click="
                            survivor.sheet['Weapon Proficiency'] = survivor.sheet['Weapon Proficiency'] - 1
                        "
                    >
                        &#x25BC;
                    </button>
                    <select
                        class="kd_kickstarter_select"
                        ng-model="survivor.sheet.weapon_proficiency_type"
                        ng-options="dict.handle as dict.name for dict in settlement.game_assets.weapon_proficiency_types"
                        ng-selected="survivor.sheet.weapon_proficiency_type"
                    >
                        <option disabled value="">Type</option>
                    </select>
                    <button
                        class="kd_kickstarter_button kd_blue"
                        ng-click="
                            setWeaponProficiencyAttribs();
                            rollUp('weaponProficiencyControl')
                        "
                    >
                        Save & Close
                    </button>
                </div><!-- number tumbler-->
            </div>
        </div>

        <!-- COURAGE -->
        <div
            class="survivor_sheet_kd_sheet_ui_box border clickable"
            ng-click="rollUp('courageControl')"
            ng-class="{
                'rolled_down': ngRolledUp['courageControl'] === false,
            }"
            title="Courage controller for {{survivor.sheet.name}}. Tap or click to edit!"
        >
            <div class="kd_sheet_ui_row">
                <div class="title">
                    Courage
                </div>
                <div class="kd_sheet_ui_box_row long">
                    <span
                        class="kd_sheet_ui_box"
                        ng-repeat="value in [0,1,2,3,4,5,6,7,8]"
                        ng-class="{
                            'checked': survivor.sheet.Courage > value,
                            'heavy': [2,8].indexOf(value) !== -1,
                        }"
                    ></span>
                </div>
            </div>
            <div
                class="ng_fade font_small kd_sheet_ui_row_tip"
                ng-if="
                    scratch.courageAI !== undefined &&
                    ngRolledUp['courageControl'] !== false
                "
            >
                <b class="capitalize">
                    {{scratch.courageAI}}:
                </b>
                <span
                    ng-bind-html="
                        settlement.game_assets.abilities_and_impairments[scratch.courageAI].desc|trustedHTML
                    "
                >
                </span>
            </div>
        </div>

        <div
            id="courageControl"
            class="kd_sheet_ui_roll_down rolled_up"
        >
            <div class="kd_sheet_ui_roll_down_controls integrated">

                <!-- tips from the campaign about courage AIs -->
                <div class="kd_sheet_ui_ai_toggle_tip_row">
                    <div
                        class="dynamic_tip_container"
                        ng-repeat="
                            m in settlement.survivor_attribute_milestones.Courage
                        "
                        ng-if="m.event == 'story_events'"
                    >
                        <span
                            class="kd_sheet_ui_box small"
                            ng-class="{checked: survivor.sheet.Courage >= m.values[0]}"
                            ng-repeat="i in numberToRange(m.boxes) track by $index"
                        ></span>
                        <font class="kdm_font">g</font>
                        <b>{{settlement.game_assets.events[m.handle].name}}</b>
                        <span class="font_small">
                            (p.{{settlement.game_assets.events[m.handle].page}})
                        </span>
                    </div>
                </div>

                <div
                    class="ng_fade kd_sheet_ui_ai_toggle_container"
                    ng-if="
                        settlement.game_assets.campaign.courage_ai_radio_raft !== false &&
                        survivor.sheet.Courage > 2
                    "
                    ng-init="setAttributeAI('courage')"
                >

                    <div
                        class="kd_sheet_ui_ai_toggle_item"
                        ng-repeat="cAI in [
                            {
                                'handle': 'stalwart', 
                                'desc': 'Cant be knocked down by brain trauma or intimidate.',
                            },
                            {
                                'handle': 'prepared',
                                'desc': 'Add Hunt XP to your roll when determining a straggler.',
                            },
                            {
                                'handle': 'matchmaker',
                                'desc': 'Spend 1 endeavor to trigger Intimacy story event.',
                            },
                        ]"
                        ng-init="
                            cAI['id'] = 'courageAI' + cAI['handle'];
                        "
                    >
                        <input
                            id="{{'courageAI' + cAI.handle}}"
                            name="courage_ai"
                            type="radio"
                            ng-model="scratch.courageAI"
                            ng-value="cAI['handle']"
                        >
                        <label
                            for="{{cAI.id}}"
                            ng-class="{
                                'last': $index >= 2,
                            }"
                        >
                            <b class="capitalize">
                                {{cAI.handle}}:
                            </b>
                            {{cAI.desc}}
                        </label>
                    </div>

                </div> <!-- AI toggle container -->


                <div class="kd_sheet_ui_number_tumbler">
                    <button
                        class="kd_kickstarter_button"
                        ng-click="
                            survivor.sheet.Courage = survivor.sheet.Courage + 1
                        "
                    >
                        &#x25B2;
                    </button>
                    <button
                        class="kd_kickstarter_button"
                        ng-click="
                            survivor.sheet.Courage = survivor.sheet.Courage - 1
                        "
                    >
                        &#x25BC;
                    </button>
                    <button
                        class="kd_kickstarter_button kd_blue"
                        ng-click="
                            updateCourage();
                            rollUp('courageControl')
                        "
                    >
                        Save Changes
                    </button>
                </div> <!-- number tumbler -->
            </div>
        </div>

        <!-- UNDERSTANDING -->
        <div
            class="survivor_sheet_kd_sheet_ui_box border clickable"
            ng-class="{
                'rolled_down': ngRolledUp['understandingControl'] === false,
            }"
            ng-click="rollUp('understandingControl')"
            title="Understanding controller for {{survivor.sheet.name}}. Tap or click to edit!"
        >
            <div class="kd_sheet_ui_row">
                <div class="title">
                    Understanding
                </div>
                <div class="kd_sheet_ui_box_row long">
                    <span
                        class="kd_sheet_ui_box"
                        ng-repeat="value in [0,1,2,3,4,5,6,7,8]"
                        ng-class="{
                            'checked': survivor.sheet.Understanding > value,
                            'heavy': [2,8].indexOf(value) !== -1,
                        }"
                    ></span>
                </div>
            </div>

            <div
                class="ng_fade font_small kd_sheet_ui_row_tip"
                ng-if="
                    scratch.understandingAI !== undefined &&
                    ngRolledUp['understandingControl'] !== false
                "
            >
                <b class="capitalize">
                    {{scratch.understandingAI}}:
                </b>
                <span
                    ng-bind-html="
                        settlement.game_assets.abilities_and_impairments[scratch.understandingAI].desc|trustedHTML
                    "
                >
                </span>
            </div>
        </div>

        <div
            id="understandingControl"
            class="kd_sheet_ui_roll_down rolled_up"
        >
            <div class="kd_sheet_ui_roll_down_controls integrated">

                <!-- understanding tips from the campaign -->
                <div class="kd_sheet_ui_ai_toggle_tip_row">
                    <div
                        class="dynamic_tip_container"
                        ng-repeat="m in settlement.survivor_attribute_milestones.Understanding"
                        ng-if="m.event == 'story_events'"
                    >
                        <span
                            class="kd_sheet_ui_box small"
                            ng-class="{checked: survivor.sheet.Understanding >= m.values[0]}"
                            ng-repeat="i in numberToRange(m.boxes) track by $index"
                        ></span>
                        <font class="kdm_font">g</font>
                        <b>{{settlement.game_assets.events[m.handle].name}}</b>

                        <span class="font_small">
                            (p.{{settlement.game_assets.events[m.handle].page}})
                        </span>

                    </div>
                </div>

                <div
                    class="ng_fade kd_sheet_ui_ai_toggle_container"
                    ng-if="
                        settlement.game_assets.campaign.understanding_ai_radio_raft !== false &&
                        survivor.sheet.Understanding > 2
                    "
                    ng-init="setAttributeAI('understanding')"
                >
                    <div
                        class="kd_sheet_ui_ai_toggle_item"
                        ng-repeat="uAI in [
                            {
                                'handle': 'analyze',
                                'desc': 'Look at the top AI card and return it to the top of the deck.',
                            },
                            {
                                'handle': 'explore',
                                'desc': 'Add +2 to your <b>investigate</b> roll results.',
                            },
                            {
                                'handle': 'tinker',
                                'desc': '+1 endeavor when a returning survivor.',
                            },
                        ]"
                        ng-init="
                            uAI['id'] = 'understandingAI' + uAI['handle'];
                        "
                    >
                        <input
                            id="{{'understandingAI' + uAI.handle}}"
                            name="understanding_ai"
                            type="radio"
                            ng-model="scratch.understandingAI"
                            ng-value="uAI['handle']"
                        >
                        <label
                            for="{{uAI.id}}"
                            ng-class="{
                                'last': $index >= 2,
                            }"
                        >
                            <b class="capitalize">
                                {{uAI.handle}}:
                            </b>
                            <span
                                ng-bind-html="uAI.desc|trustedHTML"
                            >
                            </span>
                        </label>
                    </div>

                </div><!-- AI toggle container -->


                <div class="kd_sheet_ui_number_tumbler">
                    <button
                        class="kd_kickstarter_button"
                        ng-click="
                            survivor.sheet.Understanding = survivor.sheet.Understanding + 1
                        "
                    >
                        &#x25B2;
                    </button>
                    <button
                        class="kd_kickstarter_button"
                        ng-click="
                            survivor.sheet.Understanding = survivor.sheet.Understanding - 1
                        "
                    >
                        &#x25BC;
                    </button>
                    <button
                        class="kd_kickstarter_button kd_blue"
                        ng-click="
                            updateUnderstanding();
                            rollUp('understandingControl')
                        "
                    >
                        Save & Close
                    </button>
                </div> <!-- number tumbler -->
            </div>
        </div> <!-- understanding control -->


        <!-- Echoes of Death 3 - Sword Oath -->
        <div
            class="ng_fade survivor_sheet_kd_sheet_ui_box border clickable"
            ng-if="survivor.sheet.fighting_arts.indexOf('sword_oath') !== -1"
            ng-class="{
                'rolled_down': ngRolledUp['swordOathControl'] === false,
            }"
            ng-click="rollUp('swordOathControl')"
            title="Sword Oath controller for {{survivor.sheet.name}}. Tap or click to edit!"
        >

            <div class="kd worksheet_row">
	    		<div>
	            	Sword Oath
                </div>

                <div
                    class="subtitle"
                    ng-if="survivor.sheet.sword_oath.sword"
                >
                    : <b>
                        {{settlement.game_assets.gear[survivor.sheet.sword_oath.sword].name}}
                    </b>
                    ({{survivor.sheet.sword_oath.wounds}})
                </div>
			</div>

            <div
				class="kd worksheet_row checkbox_container"
				ng-if="survivor.sheet.sword_oath.wounds > 0"
			>
                <div
                    ng-repeat="block in range(survivor.sheet.sword_oath.wounds)"
                    ng-class="{
                        'red': block >= 17,
                    }"
                    class="kd checkbox checked"
                >
                </div>
            </div>
		</div>
		<!-- survivor_sheet_kd_sheet_ui_box -->

		<div
  	        id="swordOathControl"
       	    class="kd_sheet_ui_roll_down rolled_up"
        >

            <div class="kd_sheet_ui_roll_down_controls integrated">

                <div class="kd_sheet_ui_number_tumbler">

                    <select
                        class="kd_kickstarter_select"
						ng-change="survivor.sheet.sword_oath.wounds = 0"
                        ng-model="survivor.sheet.sword_oath.sword"
                        ng-options='gear.handle as gear.name for gear in settlement.game_assets.gear| hasKeyword: "sword"'
                    >
                        <option value="" disabled selected>
                            Select Sword
                        </option>
                    </select>

   	                <button
       	                class="kd_kickstarter_button"
                    	ng-if="survivor.sheet.sword_oath.sword"
            	        ng-click="
               	            survivor.sheet.sword_oath.wounds = survivor.sheet.sword_oath.wounds + 1
                   	    "
                    >
   	                    &#x25B2;
       	            </button>
           	        <button
               	        class="ng_fade kd_kickstarter_button"
                        ng-disabled="survivor.sheet.sword_oath.wounds === 0"
	                    ng-if="survivor.sheet.sword_oath.sword"
                   	    ng-click="
                            survivor.sheet.sword_oath.wounds = survivor.sheet.sword_oath.wounds - 1
   	                    "
       	            >
           	            &#x25BC;
               	    </button>
                    <button
   	                    class="ng_fade kd_kickstarter_button kd_blue"
       	                ng-click="
           	                setSwordOath(survivor);
               	            rollUp('swordOathControl')
                   	    "
                    >
   	                    Save & Close
       	            </button>
           	    </div> <!-- number tumbler -->
            </div><!-- roll down integrated -->
	    </div>
    	<!-- Echoes of Death 3 - Sword Oath -->


    </div> <!-- survivor_sheet_secondary_attribs_container -->


    <!-- potstars constellations! -->

    <div
        class="font_small survivor_sheet_kd_sheet_ui_box border"
        ng-if="settlement.sheet.campaign === 'people_of_the_stars'"
        ng-controller="theConstellationsController"
    >
        <div
            class="survivor_sheet_the_constellations_title_bar"
        >
            If marked traits complete a horizontal or vertical line, 
            <font class="kdm_font">g</font> Faces in the Sky
            (p.{{settlement.game_assets.events.dk_faces_in_the_sky.page}}).
        </div>

        <div
            class="survivor_sheet_potstars_the_constellations_container"
        >
            <table class="survivor_sheet_potstars_the_constellations_table">
                <tr class="underline">
                    <th></th>
                    <th>Witch</th>
                    <th>Rust</th>
                    <th>Storm</th>
                    <th>Reaper</th>
                </tr>
                <tr class="underline">
                    <th>Gambler</th>
                    <td
                        ng-repeat="(cell, name) in {
                            'A1': '9+ UND',
                            'B1': 'Destined Disorder',
                            'C1': 'Fated Blow FA',
                            'D1': 'Pristine Ability',
                        }"
                        ng-class="{
                            'active': survivor.dragon_traits.active_cells.includes('{{cell}}')
                        }"
                    >
                        {{name}}
                    </td>
                </tr>
                <tr class="underline">
                    <th>Absolute</th>
                    <td
                        ng-repeat="(cell, name) in {
                            'A2': 'Reincarnated',
                            'B2': 'Frozen Star SFA',
                            'C2': 'Irid. Hide Abil.',
                            'D2': 'Champion\'s Rite FA',
                        }"
                        ng-class="{
                            'active': survivor.dragon_traits.active_cells.includes('{{cell}}')
                        }"
                    >
                        {{name}}
                    </td>
                </tr>
                <tr class="underline">
                    <th>Sculptor</th>
                    <td
                        ng-repeat="(cell, name) in {
                            'A3': 'Scar',
                            'B3': 'Noble',
                            'C3': 'Weapon Master',
                            'D3': '+1 Base ACC',
                        }"
                        ng-class="{
                            'active': survivor.dragon_traits.active_cells.includes('{{cell}}')
                        }"
                    >
                        {{name}}
                    </td>
                </tr>
                <tr>
                    <th>Goblin</th>
                    <td
                        ng-repeat="(cell, name) in {
                            'A4': 'Oracle\'s Eye',
                            'B4': 'Unbreakable FA',
                            'C4': '3+ Base STR',
                            'D4': '9+ COU',
                        }"
                        ng-class="{
                            'active': survivor.dragon_traits.active_cells.includes('{{cell}}')
                        }"
                    >
                        {{name}}
                    </td>
                </tr>
            </table><!-- table -->

            <select
                class="font_medium kd_kickstarter_select"
                ng-if="survivor.dragon_traits.available_constellations.length >= 1"
                ng-model="survivor.sheet.constellation"
                ng-options="c for c in survivor.dragon_traits.available_constellations"
                ng-change="setConstellation(survivor.sheet.constellation)"
                ng-selected="survivor.sheet.constellation"
            >
                <option disabled value="">Choose a Constellation</option>
            </select>

            <button
                class="font_medium kd_kickstarter_button"
                ng-if="survivor.sheet.constellation != undefined"
                ng-click="unsetConstellation()"
            >
                Unset Constellation
            </button>

        </div><!-- table container -->

    </div><!-- the constellations -->


     <!-- 

        SURVIVOR SPECIAL ATTRIBUTES
            campaign-specific attribs, e.g. sun-eater, DK scar, etc.
        
    -->

    <div
        ng-if="settlement.game_assets.survivor_special_attributes.length >= 1"
        class="survivor_sheet_special_attributes_container"
    >
       <div
            class = "survivor_sheet_special_attribute_container clickable"
            ng-repeat="s in settlement.game_assets.survivor_special_attributes"
            ng-click="toggleSpecialAttrib(s.handle)"
            ng-class="{active: survivor.sheet[s.handle] == true}"
            title = "{{s.title_tip}}"
        >
            <div
                class="special_attribute_checkbox"
                ng-class="{active: survivor.sheet[s.handle] == true}"
            >
            </div>

            <div
                class="special_attribute_text"
                ng-class="{active: survivor.sheet[s.handle] == true}"
            >
                {{s.name}}
            </div>
        </div>
    </div> <!-- survivorSpecialAttribsController -->


    </div> <!-- end of the middle column! -->


    <div id="survivorSheetRightColumn" >

        <!-- FARTING ARTS -->
        <div
            class="survivor_sheet_secondary_attrib_container"
            ng-controller='fightingArtsController'
            ng-init="setFAoptions()"
            ng-if="survivor.sheet.fighting_arts != undefined"
        >
            <div class="secondary_attribute_title_bar">
                <div class="font_large title">Fighting Arts</div>
                <div class="font_small subtitle">Maximum 3.</div>
                <div
                    class="font_small lockbox clickable"
                    ng-click="toggleStatusFlag('cannot_use_fighting_arts')"
                >
                    <div
                        class="kd_sheet_ui_box"
                        ng-class="
                            {checked: survivor.sheet.cannot_use_fighting_arts
                        }"
                    >
                    </div>
                    <span>
                        &nbsp; &#x1f512; Cannot use Fighting Arts
                    </span>
                </div>
            </div> <!-- title elements -->


            <div
                title="Click or tap to remove survivor Fighting Arts."
                class="survivor_sheet_card_container"
            >
                <div
                    ng-repeat="fa_handle in survivor.sheet.fighting_arts"
                    class="ng_fade survivor_sheet_card survivor_sheet_gradient clickable"
                    ng-class="{true: 'faded'}[survivor.sheet.cannot_use_fighting_arts]"
                >

                    <div ng-if = "settlement.game_assets.fighting_arts[fa_handle] === undefined">
                        <img src="/media/loading_lantern.gif"><br/>
                        Loading Fighting Art data...
                    </div>

                    <div
                        class="survivor_sheet_card_content"
                        ng-init="
                            FA = settlement.game_assets.fighting_arts[fa_handle];
                            expansion_handle = settlement.game_assets.fighting_arts[fa_handle].expansion;
                            expansion_dict = settlement.game_assets.expansions[expansion_handle];
                        "
                        ng-if="settlement.game_assets.fighting_arts[fa_handle] !== undefined"
                        ng-click="rmFightingArt(fa_handle, $index)"
                        title="Click or tap to remove {{FA.name}} from {{survivor.sheet.name}}"
                    >

                        <div
                            class="font_small survivor_sheet_card_expansion_flair"
                            ng-if="expansion_handle != null"
                            title="{{expansion_dict.name}} expansion Fighting Art"
                            style='
                                color: #{{expansion_dict.flair.color}};
                                background-color: #{{expansion_dict.flair.bgcolor}};
                            '
                            >
                            {{expansion_dict.name}}
                        </div>

                            <!-- regular title -->
                        <span
                            class="font_large card_title"
                            ng-class="{
                                'card_constellation': FA.constellation !== undefined,
                            }"
                        >
                            {{FA.name}}
                        </span>

                            <!-- subhead -->
                        <p
                            class="font_small survivor_sheet_card_subhead"
                            ng-if="FA.sub_type != 'strain'"
                        >
                            - {{FA.sub_type_pretty}} -
                        </p>
                        <p
                            class="font_small survivor_sheet_card_subhead"
                            ng-if="FA.sub_type === 'strain'"
                        >
                            - fighting art, strain -
                        </p>

                        <p class="survivor_sheet_card_color_span {{FA.sub_type}}_gradient"> </p>
                        <div
                            class="font_medium survivor_sheet_card_text"
                            ng-bind-html="FA.desc|trustedHTML"
                        >
                        </div>

                        <div
                            ng-repeat="(level, desc) in FA.levels track by $index"
                            ng-if="desc != ''"
                            title="Tap or click a {{FA.name}} skill level to toggle it on or off."
                        >
                            <div
                                class="clickable font_medium survivor_sheet_card_level_block"
                                ng-click="toggleLevel($event, fa_handle, level)"
                                ng-if="survivor.sheet.fighting_arts_levels[fa_handle].indexOf($index) !== -1"
                            >
                                <span class="survivor_sheet_card_level_number toggled_on">{{level}}</span>
                                <span
                                    class="survivor_sheet_card_level_desc toggled_on"
                                    ng-bind-html="desc|trustedHTML"
                                >
                                </span>
                            </div>
                            <div
                                class="clickable font_medium survivor_sheet_card_level_block"
                                ng-click="toggleLevel($event, fa_handle, level)"
                                ng-if="survivor.sheet.fighting_arts_levels[fa_handle].indexOf($index) === -1"
                            >
                                <span class="survivor_sheet_card_level_number">{{level}}</span>
                                <span class="survivor_sheet_card_level_desc" ng-bind-html="desc|trustedHTML"></span>
                            </div>
                        </div> <!-- levels -->

                        <!-- Strain Treshold - 10th Anniversary White Speaker, etc. -->

                        <div
                            ng-if="FA.strain_threshold !== undefined"
                            class="fighting_art_card_strain_threshold_container"
                            ng-class="{
                                'kd_promo': FA.strain_threshold.final === undefined,
                                'kd_pink': FA.strain_threshold.final,
                            }"
                        >
                            <div
                                class="fighting_art_card_strain_threshold_blocks_container"
                            >
                                <span
                                    ng-repeat="block in range(FA.strain_threshold.blocks)"
                                    class="strain_block"
                                >
                                </span>
                            </div>
                            <div
                                class="fighting_art_card_strain_threshold_desc"
                                ng-bind-html="FA.strain_threshold.desc|trustedHTML"
                            >
                            </div>
                        </div>

                    </div>

                    <div
                        class="kd font_small survivor_sheet_card_click_to_remove"
                    >
                        Tap or click to <b>remove</b>.
                    </div>

                </div><!-- survivor_sheet_Card, i.e. the repeater -->

            </div> <!-- survivor_sheet_card_container -->

            <div
                class="ng_fade survivor_sheet_card_asset_list_container"
                ng-if="survivor.sheet.fighting_arts.length <= 2"
            >
                <select
                    name="add_fighting_arts"
                    class="kd_kickstarter_select"
                    ng-if="FAoptions != undefined"
                    ng-model="userFA.newFA"
                    ng-change="addFightingArt(); userFA.newFA = FAoptions[0]"
                    ng-blur="userFA.newFA = FAoptions[0]"
                    ng-options="fa.handle as fa.selector_text for fa in FAoptions | orderObjectBy:'handle':false"
                >
                    <option value="" disabled selected>Add Fighting Art</option>
                </select>
                <span ng-if="FAoptions == undefined">Refreshing options...</span>
            </div>


        </div> <!-- fartingArtsController -->

        <!-- DISORDERS -->
        <div
            class="survivor_sheet_secondary_attrib_container"
            ng-controller="disordersController"
            ng-if="survivor.sheet != undefined"
        >
            <div class="secondary_attribute_title_bar">
                <div class="font_large title">Disorders</div>
                <div class="font_small subtitle">Maximum 3.</div>
                <div class="font_small lockbox"><!-- empty --></div>
            </div> <!-- title elements -->


            <div
                title="Click or tap to remove survivor Disorders."
                class="survivor_sheet_card_container disorders_container"
            >
                <div
                    ng-repeat="d_handle in survivor.sheet.disorders"
                    class="ng_fade survivor_sheet_card disorder_card_gradient clickable"
                >
                    <div ng-if = "settlement.game_assets.disorders[d_handle] == undefined">
                        <img src="/media/loading_lantern.gif"><br/>
                        Loading Disorder data...
                    </div>

                    <div
                        class="survivor_sheet_card_content"
                        ng-init="
                            D = settlement.game_assets.disorders[d_handle];
                            expansion_handle = settlement.game_assets.disorders[d_handle].expansion;
                            expansion_dict = settlement.game_assets.expansions[expansion_handle];
                        "
                        ng-if = "settlement.game_assets.disorders[d_handle] != undefined"
                        ng-click="rmDisorder(d_handle, $index)"
                        title="Click or tap to remove {{D.name}} from {{survivor.sheet.name}}"
                    >
                        <!-- EXPANSION FLAIR -->

                        <div
                            class="font_small survivor_sheet_card_expansion_flair"
                            ng-if="expansion_handle != null"
                            title="{{expansion_dict.name}} expansion Disorder"
                            style='
                                color: #{{expansion_dict.flair.color}};
                                background-color: #{{expansion_dict.flair.bgcolor}};
                            '
                        >
                            {{expansion_dict.name}}
                        </div>

                        <!-- regular title -->
                        <span
                            class="font_large card_title"
                            ng-class="{
                                'card_constellation': D.constellation !== undefined,
                            }"
                        >
                            {{D.name}}
                        </span>

                        <div
                            class="font_medium survivor_sheet_card_text disorder_flavor_text"
                            ng-bind-html="D.flavor_text|trustedHTML"
                        >
                        </div>
                        <div
                            class="font_medium survivor_sheet_card_text"
                            ng-bind-html="D.survivor_effect|trustedHTML"
                        >
                        </div>

                    </div> <!-- card_content -->

                    <div
                        class="kd font_small survivor_sheet_card_click_to_remove disorder"
                    >
                        Tap or click to <b>remove</b>.
                    </div>

                </div> <!-- disorder ng-repeat -->

            </div> <!-- disorders survivor_sheet_card_container -->

            <div
                class="ng_fade survivor_sheet_card_asset_list_container"
                ng-if="survivor.sheet.disorders.length <= 2"
            >
                <select
                    name="add_disorders"
                    class="kd_kickstarter_select"
                    ng-if="dOptions != undefined"
                    ng-model="userD.newD"
                    ng-change="addDisorder(); userD.newD = dOptions[0]"
                    ng-blur="userD.newD = dOptions[0]"
                    ng-options="d.handle as d.selector_text for d in dOptions | orderObjectBy:'handle':false"
                >
                    <option value="" disabled selected>Add Disorder</option>
                </select>
            </div>
        </div> <!-- disordersController -->


        <!-- ABILITIES AND IMPAIRMENTS -->
        <div class="survivor_sheet_secondary_attrib_container">

            <div>
                <div class="secondary_attribute_title_bar">
                    <div class="font_large title">Abilities & Impairments</div>
                    <div
                        class="clickable font_small lockbox"
                        ng-click="toggleStatusFlag('skip_next_hunt')"
                    >
                        <div
                            class="kd_sheet_ui_box"
                            ng-class="{
                                'checked': survivor.sheet.skip_next_hunt
                            }"
                        >
                        </div>
                        <span>
                            &nbsp; &#x1f512; Skip next hunt
                        </span>
                    </div>
                </div>
            </div> <!-- title elements -->

            <div
                class="outer_ai_container"
                title="Click or tap to remove survivor Abilities & Impairments."
            >

                <div
                    class="ng_fade ai_repeater clickable"
                    ng-repeat="ai_handle in survivor.sheet.abilities_and_impairments track by $index"
                    title="Click or tap to remove '{{settlement.game_assets.abilities_and_impairments[ai_handle].name}}'"
                >

                    <div
                        ng-if="ai_handle !== 'partner'"
                        ng-click="rmAI(ai_handle, $index)"
                    >
                        <b
                            ng-if="settlement.game_assets.abilities_and_impairments[ai_handle].constellation == undefined"
                        >
                            {{settlement.game_assets.abilities_and_impairments[ai_handle].name}}:
                        </b>
                        <b
                            ng-if="settlement.game_assets.abilities_and_impairments[ai_handle].constellation != undefined"
                            class="card_constellation"
                        >
                            {{settlement.game_assets.abilities_and_impairments[ai_handle].name}}:
                        </b>

                        <span
                            class="survivor_sheet_ai_desc"
                            ng-bind-html="settlement.game_assets.abilities_and_impairments[ai_handle].desc|trustedHTML"
                        >
                        </span>
                    </div>


                    <!-- PARTNER CONTROLS -->
                    <div
                        class="survivor_sheet_partner_controls"
                        ng-if="ai_handle === 'partner'"
                    >

                        <div
                            class="
                                survivor_sheet_kd_sheet_ui_box
                                survivor_sheet_partner_opener
                                clickable
                                settlement_sheet_gradient
                            "
                            ng-if="survivor.sheet.partner_id == undefined"
                            ng-click="showHide('partnerSelect')"
                        >
                            Select a Partner
                        </div>

                        <div
                            class="
                                survivor_sheet_kd_sheet_ui_box
                                settlement_sheet_gradient
                                survivor_sheet_partner
                                clickable
                            "
                            ng-if="survivor.sheet.partner_id != undefined"
                            ng-click="showHide('partnerSelect')"
                            title="{{survivor.sheet.name}}'s partner is {{partner.sheet.name}}. Click or tap to modify!"
                        >
                            <img
                                ng-if="partner.sheet.avatar != undefined"
                                class="survivor_sheet_partner_avatar"
                                ng-src="{{api_url}}avatar/get/{{partner.sheet.avatar.$oid}}"
                            />
                            <img
                                ng-if="partner.sheet.avatar == undefined"
                                class="survivor_sheet_partner_avatar"
                                ng-src="/media/default_avatar_{{partner.sheet.effective_sex}}.png"
                            />
                            <p>
                                <b>Partner - {{partner.sheet.name}}:</b>
                                <span ng-bind-html="settlement.game_assets.innovations.partnership.desc|trustedHTML"></span>
                            </p>
                        </div>


                    </div> <!-- ng-if="ai_handle === 'partner'" -->

                </div> <!-- ai_repeater. Yes, it ends all the way down here. -->

            </div> <!-- ai 'card' outer container -->

            <select
                id="survivorSheetAISelector"
                name="add_abilities_and_impairments"
                class="kd_kickstarter_select"
                ng-if="AIoptions != undefined"
                ng_model="scratch.newAI"
                ng_change="addAI()"
                ng-options="ai.handle as (ai.name + ' (' + ai.sub_type_pretty + ')'  ) for ai in AIoptions"
            >
                <option value="" disabled selected>Add Abilities & Impairments</option>
            </select>

        </div> <!-- ai -->

    </div> <!-- right panel -->


    <!-- lineage block starts here -->


	<!-- loading -->
    <center
		class="ng_fade"
		ng-if="
			settlement === undefined ||
			survivor === undefined
		"
	>
		<div ng-if="settlement === undefined">
			Waiting for settlement data...
		</div>
		<div ng-if="survivor === undefined">
			Waiting for survivor data...
		</div>
	</center>



</div> <!-- end of the survivor sheet! -->

<!-- 

    GEAR GRID starts here!

-->

<div
    id="survivorGearGridTab"
    class="view_tab"
    ng-show='tabsObject.activeTab === 1'
>

    <div
        class="survivor_sheet_gear_grid_container"
		ng-init="scratch.showGearGrid = true"
    >

    <table>
        <tr
            ng-repeat="row in ['top','middle','bottom']"
            title="{{row}} row"
        >
            <td
                ng-repeat="col in ['left','middle','right']"
            >
				<center>{{row}}_{{col}}</center>

                <div class="gear_card_container gear_card_gradient">
					<center
						ng-if="survivor.sheet.gear_grid[row + '_' + col]"
					>
						{{settlement.game_assets.gear[survivor.sheet.gear_grid[row + '_' + col]].name}}
						<hr/>
						<font class="font_small">
							{{settlement.game_assets.gear[survivor.sheet.gear_grid[row + '_' + col]].sub_type_pretty}}
						</font>
					</center>
					<div
						ng-if="!survivor.sheet.gear_grid[row + '_' + col]"
					>
						<center>None</center>
					</div>
                </div>

                <select
                    class="kd_kickstarter_select"
                    ng-model="survivor.sheet.gear_grid[row + '_' + col]"
                    ng-options='gear.handle as gear.name for gear in settlement.game_assets.gear'
                >
                    <option value="" disabled selected>
                        Select Gear
                    </option>
                </select>
            </td>
        </tr>
    </table>

	<button
		class="kd capsule"
		ng-click="survivor.sheet.gear_grid = {}"
	>
		Reset / Clear
	</button>

	<button
		class="kd capsule blue"
		ng-click="setGearGrid()"
	>
		Save Changes
	</button>

    </div><!-- gear grid container -->

</div> <!-- gear grid  tab ends -->

    <!-- 

        'Notes' tab starts here 

    -->

    <div
        id="survivorViewNotesTab"
        class="view_tab"
        ng-show='tabsObject.activeTab === 2'
    >

        <!-- 
            notes 
        -->

        <div
            id="survivorSheetNotesContainer"
            class="survivor_sheet_kd_sheet_ui_box border top_most"
        >

            <div
                class="survivor_sheet_notes_container"
            >
                <div
                    class="survivor_sheet_new_note_container"
                >

                    <div
                        id="survivorNoteControls"
                        class="survivor_sheet_new_note_container"
                    >
                        <div
                            class="survivor_sheet_new_note_title_bar"
                        > 
                            <div
                                id="survivorNoteNewNoteInput"
                                contenteditable="true"
                                class="survivor_sheet_new_note_input"
                                placeholder="Add a note..."
                                spellcheck="true"
                                ng-init="initNewSurvivorNote();"
                                ng-blur="
                                    setNewSurvivorNoteBody();
                                "
                                ng-focus="scratch.newNoteHasFocus = true"
                            >
                            </div>
                            <div
                                title="Tap or click to pin/unpin this note! Pinned notes are sorted to the top of the list of survivor notes."
                                class="clickable survivor_sheet_note_pushpin"
                                ng-init="
                                    scratch.newSurvivorNote.pinned = false;
                                "
                                ng-click="
                                    scratch.newSurvivorNote.pinned = !scratch.newSurvivorNote.pinned;
                                "
                                ng-class="{
                                    'active': scratch.newSurvivorNote.pinned,
                                }"
                            >
                                &#128204;
                            </div>
                        </div>

                        <div
                            ng-if="scratch.newNoteHasFocus"
                            class="kd_kickstarter_button_raft"
                        >
                            <button
                                class="ng_fade kd_kickstarter_button kd_blue"
                                ng-click="addNewSurvivorNote();"
                            >
                                Save note
                            </button>
    
                            <button
                                class="kd_kickstarter_button"
                                ng-click="
                                    scratch.newNoteHasFocus = false;
                                    initNewSurvivorNote();
                                "
                            >
                                Close
                            </button>
                        </div>

                    </div>

                </div> <!-- new_note_container -->

                <div
                    class="survivor_sheet_note_repeater_container"
                    ng-if="survivor.notes.length > 0"
                    ng-repeat="pinnedValue in [true, false]"
                >
                    <div
                        class="survivor_sheet_note_repeater"
                        ng-if="
                            note.deleted === undefined &&
                            note.pinned === pinnedValue
                        "
                        ng-repeat="note in survivor.notes|orderBy:'-created_on'"
                        ng-init="
                            toolsDivId = note._id.$oid + 'ToolsDiv';
                            originalNoteContent = note.note
                        "
                    >
                        <!-- hack city!!! -->
                        <span id="{{toolsDivId}}">
                        </span>

                        <div
                            id="survivorNoteBodyId{{note._id.$oid}}"
                            contenteditable="true"
                            class="font_medium survivor_sheet_note_body"
                            title="Tap or click to manage this note!"
                            ng-bind-html="note.note|trustedHTML"
                            ng-class="{
                                'pinned': note.pinned === true && !ngVisible[toolsDivId],
                                'clickable': !ngVisible[toolsDivId],
                            }"
                            ng-click="ngShow(toolsDivId);"
                            ng-blur="updateSurvivorNote(note)"
                        >
                        </div>

                        <!-- debugger -->
                        <div
                            ng-if="NGDEBUG && ngVisible[toolsDivId]"
                            class="survivor_sheet_note_debugger"
                        >
                            {{note}}
                        </div>

                        <!-- note tools bar -->
                        <div
                            class="font_small survivor_sheet_note_meta_data_bar"
                            ng-if="ngVisible[toolsDivId]"
                        >
                            {{note.created_on.$date|date:'yyyy-MM-dd @ h:mma'}}
                        </div>
                        <div
                            class="survivor_sheet_note_tools_bar"
                            ng-if="ngVisible[toolsDivId]"
                        >

                            <div
                                title="Tap or click to pin/unpin this note! Pinned notes are sorted to the top of the list of survivor notes."
                                class="clickable font_medium survivor_sheet_note_pushpin"
                                ng-click="
                                    note.pinned = !note.pinned;
                                    updateSurvivorNote(note);
                                "
                                ng-class="{'active': note.pinned}"
                            >
                                &#128204;
                            </div>

                            <div
                                title="Tap or click to arm the remove button and remove this note."
                                class="clickable font_large survivor_sheet_note_more_options"
                            >
                                <select
                                    class="survivor_sheet_note_select"
                                    ng-change="updateSurvivorNote(note)"
                                    ng-model="note.update_operation"
                                >
                                    <option value="" selected disabled>
                                        &#8942;
                                    </option>
                                    <option>Delete</option>
                                </select>
                            </div>

                            <div
                                title="Tap or click to close these controls."
                                class="clickable font_medium"
                                ng-click="ngHide(toolsDivId);"
                            >
                                &#x274C;
                            </div>

                        </div>

                    </div>
                </div>

            </div> <!-- notes_container -->

        </div><!-- notes! -->

        <!-- tags! -->
        <div class="survivor_sheet_kd_sheet_ui_box border top_most tags_container">

            <div
                class="ng_fade survivor_sheet_tag collection_gradient"
                ng-repeat="e in survivor.sheet.epithets"
                ng-click="rmEpithet($index)"
                style="
                    background: #{{settlement.game_assets.epithets[e].bgcolor}};
                    background-color: #{{settlement.game_assets.epithets[e].bgcolor}};
                    color: #{{settlement.game_assets.epithets[e].color}};
                    border-color: #{{settlement.game_assets.epithets[e].bordercolor}};
                "
                title="{{settlement.game_assets.epithets[e].name}}. Tap or click to remove!"
            >
                <span>{{settlement.game_assets.epithets[e].name}}</span>
            </div>

            <div
                class="ng_fade survivor_sheet_tag"
                ng-if="survivor.sheet.epithets.length === 0"
            >
                Tap/click to add tags:
            </div>

            <select
                id="epithetSelect"
                name="add_epithets"
                class="survivor_sheet_tag add_tag"
                ng-model="scratch.new_epithet"
                ng-change="addEpithet()"
                ng-options="e.handle as e.name for e in epithetOptions"
            >
                <option value="" disabled selected> + </option>
            </select>

        </div> <!-- tags end here! -->




        <div
            id="survivorSheetBiographyContainer"
            ng-controller="lineageController"
            class="survivor_sheet_kd_sheet_ui_box"
        >

            <h3>Survivor Biography</h3>

            <!-- founder -->
            <p ng-if="survivor.sheet.founder == true">
                <font class="kdm_font_hit_locations">a</font>
                Founding member of {{settlement.sheet.name}}.
            </p>

            <!-- born or joined -->
            <p ng-if="survivor.sheet.father != undefined || survivor.sheet.mother != undefined">
                <font class="kdm_font_hit_locations">a</font>
                Born in LY{{survivor.sheet.born_in_ly}}.
            </p>
            <p ng-if="survivor.sheet.father == undefined && survivor.sheet.mother == undefined && survivor.sheet.founder == false">
                <font class="kdm_font_hit_locations">a</font>
                Joined the settlement in LY{{survivor.sheet.born_in_ly}}.
            </p>

        <!-- inheritance -->
        <div ng-repeat="parent in ['father','mother']">
            <p ng-repeat="ai in survivor.sheet.inherited[parent].abilities_and_impairments">
                <font class="kdm_font_hit_locations">a</font> Inherited <b>{{settlement.game_assets.abilities_and_impairments[ai].name}}</b> from <b>{{survivor.sheet.parents[parent].name}}</b> ({{parent}}).
            </p>
            <p ng-if="survivor.sheet.inherited[parent].weapon_proficiency_type != null" ng-init="wp = survivor.sheet.inherited[parent].weapon_proficiency_type">
                <font class="kdm_font_hit_locations">a</font> Inherited <b>{{settlement.game_assets.weapon_proficiency_types[wp].name}}</b> proficiency from <b>{{survivor.sheet.parents[parent].name}}</b> ({{parent}}).
            </p>
            <p ng-if="survivor.sheet.inherited[parent]['Weapon Proficiency'] > 0">
                <font class="kdm_font_hit_locations">a</font> Inherited {{survivor.sheet['Weapon Proficiency']}} Weapon Proficiency points from <b>{{survivor.sheet.parents[parent].name}}</b> ({{parent}}).
            </p>
        </div>

            <!-- returning survivor -->
            <p ng-if="survivor.sheet.returning_survivor.length >= 1">
                <font class="kdm_font_hit_locations">a</font>
                Returning survivor in the following Lantern Years: {{survivor.sheet.returning_survivor.join(', ')}}.
            </p>

            <!-- retired and dead -->
            <p ng-if="survivor.sheet.retired == true" >
                <font class="kdm_font_hit_locations">a</font>
                Retired in LY{{survivor.sheet.retired_in}}.
            </p>
            <p ng-if="survivor.sheet.dead == true" class="maroon_text">
                <font class="kdm_font_hit_locations">a</font>
                <b>Died in LY{{survivor.sheet.died_in}}.</b>
            </p>

            <div
                ng-if="lineage != undefined"
                class="survivor_sheet_block_group lineage_block"
            >

            <div
                id="survivorParents"
                ng-if="survivor.sheet.founder == false"
            >
                <h4>Parents</h4>

                <select
                    class="kd_kickstarter_select"
                    ng-model="survivor.sheet.father.$oid"
                    ng-selected="survivor.sheet.father"
                    ng-options="s.sheet._id.$oid as s.sheet.name for s in settlement.user_assets.survivors | filter:maleFilter"
                    ng-change="setParent('father',survivor.sheet.father.$oid)"
                >
                    <option disabled value="">Father</option>
                </select>

                <select
                    class="kd_kickstarter_select"
                    ng-model="survivor.sheet.mother.$oid"
                    ng-selected="survivor.sheet.mother"
                    ng-options="s.sheet._id.$oid as s.sheet.name for s in settlement.user_assets.survivors | filter:femaleFilter"
                    ng-change="setParent('mother', survivor.sheet.mother.$oid)"
                >
                    <option disabled value="">Mother</option>
                </select>


            </div>

            <div ng-if="lineage.intimacy_partners >= 1">
                <h4>Intimacy Partners</h4>
                <p>
                    <span ng-repeat="s in lineage.intimacy_partners">{{s.name}}{{$last ? '' : ', '}}</span>
                </p>
            </div>

            <div ng-if="lineage.siblings.full.length >= 1 || lineage.siblings.half.length >= 1">
                <h4>Siblings</h4>
                <p ng-if='lineage.siblings.full.length >= 1'>
                    <i>Full:</i> <span ng-repeat='s in lineage.siblings.full'>
                        {{s.name}}{{$last ? '' : ', '}}
                    </span>
                </p>
                <p ng-if='lineage.siblings.half.length >= 1'>
                    <i>Half</i>: <span ng-repeat='s in lineage.siblings.half'>
                        {{s.name}}{{$last ? '' : ', '}}
                    </span>
                </p>
            </div> <!-- siblings container -->

            <div ng-if="lineage.intimacy_partners.length >= 1">
                <h4>Children</h4>
                <p span ng-repeat="p in lineage.intimacy_partners">
                    <i>with</i> <b>{{p.name}}</b> [{{p.sex}}]</b><i>: </i>
                    <span ng-repeat="s in lineage.children[p._id.$oid]">
                        {{s.name}} (LY{{s.born_in_ly}}){{$last ? '' : ', '}}
                    </span>
                </p>
            </div>
        </div> <!-- survivor_sheet_block_group lineage -->

    </div> <!-- lineage -->


</div>



<!-- 

    'Logs' tab starts here 

-->

<div
    id="survivorViewLogsTab"
    class="view_tab"
    ng-show='tabsObject.activeTab === 3'
>

    <div
        class="survivor_sheet_kd_sheet_ui_box top_most"
    >

        <h3 ng-if="lineage.events !== undefined">Survivor Event Log</h3>

        <div
            class="ng_fade full_tab_spinner"
            ng-if="lineage.events === undefined"
        >
            <img src="/media/loading_io.gif">
            <p class="font_small">Retrieving Event Log...</p>
        </div>

        <div
            class="survivor_sheet_event_log_container"
            ng-if="lineage.events !== undefined"
        >
            <div
                class="lineage_event_repeater {{event.event_type}}"
                ng-repeat="event in lineage.events"
                ng-class-even="'zebra'"
                title="Date({{event.created_on.$date|date:'yyyy-MM-dd @ h:mma'}});"
            >
                {{event.ly}} - {{event.event}}
            </div><!-- event repeater -->
        </div> <!-- events -->

    </div><!-- container -->

</div> <!-- logs tab ends -->



<!-- 

    'Admin' tab starts here 

-->

<div
    id="survivorViewAdminTab"
    class="view_tab"
    ng-show='tabsObject.activeTab === 6'
>

    <div
        class="survivor_sheet_kd_sheet_ui_box border top_most"
    >

        <h3>Multiplayer</h3>

        <div
            class="survivor_sheet_public_toggle clickable"
            ng-click="toggleBoolean('public')"
        >
            <div
                class="kd_sheet_ui_box"
                ng-class="{checked: survivor.sheet.public == true}"
            >
            </div>
            &#x1f512; Any player may manage this survivor
        </div>

        <!-- survivor email -->
        <div
            id="emailTip"
            class="kd_sheet_ui_row_tip"
            ng-if="
                user.user.preferences.show_ui_tips
            "
        >
            Enter another registered user's email address here to make them
            a player in this campaign!
        </div>

        <input
            id="survivorOwnerEmail"
            class="survivor_owner_email"
            onclick="this.select()"
            type="email"
            name="email"
            placeholder="email"
            ng-model="scratch.newSurvivorEmail"
            ng-value="survivor.sheet.email"
            ng-blur="setEmail()"
            ng-click="ngShow('survivorChangeEmailButton')"
        />

        <button
            class="kd_kickstarter_button kd_blue"
            ng-if="ngVisible['survivorChangeEmailButton']"
            ng-click="
                ngHide('survivorChangeEmailButton');
                savedAlert();
            "
        >
            Save
        </button>

        <div
            ng-if="
                user.user.subscriber.level > 1 &&
                user !== undefined &&
                lineage !== undefined
            "
            ng-init="loadUserFriends()"
        >
            <div
                id="emailTip"
                class="kd_sheet_ui_row_tip"
                ng-if="
                    user.user.preferences.show_ui_tips &&
                    user.friends.length > 0
                "
            >
                Tap/click on a friend below to make them the owner of this
                survivor record!
            </div>

            <button
                class="survivor_sheet_friend_repeater clickable kd_kickstarter_button kd_blue"
                ng-repeat="friend in user.friends track by $index"
                ng-click="
                    scratch.newSurvivorEmail = friend.login;
                    setEmail();
                "
            >
                {{ friend.login }}
            </button>

        </div>

    </div>

    <!-- permanent delete; this is going to Settlement SOON -->
    <div
        class="survivor_sheet_kd_sheet_ui_box border"
        ng-if="user.user.preferences.show_remove_button == true"
    >

        <h3 class="kd_red_text">Permanently Delete Survivor</h3>

        <div
            ng-if="user.user.preferences.show_remove_button"
        >
            <p>
                Use the button below to permanently delete <b>{{survivor.sheet.name}}</b>.
            </p>
            <p class="kd_red_text">
                <b>This cannot be undone.</b>
            </p>

            <button
                class="kd_kickstarter_button kd_pink red_glow permanently_delete"
                ng-click="showHide('removeSurvivorConfirmation')"
            >
                Delete Survivor
            </button>

        </div>

    </div><!-- survivor permanent removal controls end here -->

</div><!-- ADMIN TAB ENDS. survivorSheetController continues... -->



<!--
    
    THIS IS THE FOLD! Only Modal content below!
    Everything past here needs its own controller, etc.

-->

<div
    id="removeSurvivorConfirmation"
    class="modal hidden"
    ng-controller="removeSurvivorController"
    ng-click="ngHide('removeSurvivorConfirmation')"
>
    <div
        class="modal-content warning kd_red"
        ng-click="$event.stopPropagation()"
    >

        <div
            class="clickable corner_close_modal"
            ng-click="ngHide('removeSurvivorConfirmation')"
        >
        </div>

        <h3 class="kd_title">DELETE SURVIVOR</h3>

        <p>
            This cannot be undone! A deleted survivor can <b>never</b> be recovered.
        </p>
        <p>
            Deleting a survivor is not the same thing as using the controls
            above to mark the survivor as "Dead". Survivors should be deleted
            when they are created in error, etc.
        </p>
        <p>
            If you still want to permanently delete <b>{{survivor.sheet.name}}</b>,
            type "DELETE" (without the quotes) in the box below and then click the
            "DELETE" button that appears to permanently delete this survivor forever.
        </p>
    
        <input
            type="text"
            class="confirm_remove"
            ng-model="scratch.confirmRemove"
            placeholder="DELETE"
        />

        <button
            class="kd_kickstarter_button kd_pink red_glow ng_fade"
            ng-if="scratch.confirmRemove === 'DELETE'"
            onClick="showFullPageLoader()"
            ng-click="
                showHide('removeSurvivorConfirmation');
                removeSurvivor();
                postForm('view_campaign',settlement.sheet._id.$oid);
            "
        >
            Delete Survivor
        </button>

        <button
            class="kd_kickstarter_button ng_fade"
            ng-if="scratch.confirmRemove !== 'DELETE'"
            ng-click="showHide('removeSurvivorConfirmation')"
        >
            Close
        </button>

    </div><!-- rm_asset_confirm_container -->

</div><!-- removeSurvivorConfirmation -->


<div
    id="partnerSelect"
    class="modal-black hidden"
>
    <div
        class="partner_selector clickable survivor_sheet_gradient"
        ng-repeat="s in settlement.user_assets.survivors"
        ng-if="s.sheet.dead != true && s.sheet._id.$oid != survivor_id"
        ng-click="setPartner(s.sheet._id); showHide('partnerSelect')"
    >
        <img
            ng-if="s.sheet.avatar != undefined"
            class="partner_select_avatar"
            ng-src="{{api_url}}avatar/get/{{s.sheet.avatar.$oid}}"
        />
        <img
            ng-if="s.sheet.avatar == undefined"
            class="partner_select_avatar"
            ng-src="/media/default_avatar_{{survivor.sheet.effective_sex}}.png"
        />
        <div>
            <b>{{s.sheet.name}}</b> [{{s.sheet.sex}}]<br/>
            Hunt XP: {{s.sheet.hunt_xp}} | Courage: {{s.sheet.Courage}} | Understanding: {{s.sheet.Understanding}}<br/>
            <span ng-if="s.sheet.email != user_login"> &nbsp; <i>{{s.sheet.email}}</i></span>
        </div>
    </div>

    <button
        class="kd_kickstarter_button kd_pink"
        ng-if="survivor.sheet.partner_id != undefined"
        ng-Click="setPartner('UNSET'); showHide('partnerSelect')"
    >
        Remove partner
    </button>
    <button
        class="kd_kickstarter_button"
        ng-click="showHide('partnerSelect')"
    >
        Cancel
    </button>

</div> <!-- partner modal selection menu / partnerSelect -->


<!-- CURSED ITEMS CONTROLS -->
<div
    id="cursedItemsController"
    class="modal hidden"
    ng-if="ngVisible['cursedItemsController']"
    ng-click="ngHide('cursedItemsController')"
>
    <div
		class="modal-content survivor_affinities_modal gear_card_gradient"
		ng-click="$event.stopPropagation()"
	>

        <div
            class="clickable corner_close_modal"
            ng-click="ngHide('cursedItemsController')"
        >
        </div>

        <h3 class="kd title">Cursed Items</h3>

        <p>
			Cursed gear cannot be removed from the Survivor's gear grid.
			Archive the gear when the survivor dies.
		</p>

        <div class="kd worksheet_block">

			<div
                ng-repeat="c in settlement.game_assets.cursed_items"
                ng-click="toggleCursedItem(c.handle)"
    	        class="clickable"
			>

	            <div
    	            class="kd worksheet_row"
        	    >
                    <div
                        class="kd checkbox"
                        ng-class="{
                    		'checked': survivor.sheet.cursed_items.indexOf(c.handle) !== -1,
                        }"
                    >
                    </div>
					<div
						class="kd checkbox_desc"
						ng-bind-html="c.name|trustedHTML"
					>
					</div>
				</div> <!-- worksheet row -->
			

                <div
                    ng-repeat="a in c.abilities_and_impairments"
    	            class="ng_fade font_small kd worksheet_row"
                    ng-if="survivor.sheet.cursed_items.indexOf(c.handle) !== -1"
                >
                    <div>
                        <span
                            ng-if="settlement.game_assets.abilities_and_impairments[a] != undefined"
                            class="cursed_item_ability"
                        >
                            {{settlement.game_assets.abilities_and_impairments[a].name}} -
                        </span>
                        <span
                            class="cursed_item_ability_desc"
                            ng-if="settlement.game_assets.abilities_and_impairments[a] != undefined"
                            ng-bind-html="settlement.game_assets.abilities_and_impairments[a].desc|trustedHTML"
                        >
                        </span>
                    </div>
                </div><!-- worksheet row-->

			</div><!-- repeater/clicker -->

        </div> <!-- worksheet_block -->

    </div> <!-- modal-content -->

</div> <!-- cursed items modal -->


<!-- SAVIOR CONTROLS -->


<div
    ng-controller="saviorController"
    id="modalSavior"
    class="modal hidden"
    ng-if="ngVisible['modalSavior']"
    ng-click="ngHide('modalSavior')"
>

    <div class="modal-content" ng-click="$event.stopPropagation">

        <span
            class="corner_close_modal"
            ng-click="ngHide('modalSavior')"
        ></span>

        <h3 class="kd title">Savior</h3>

        <p>
            Use these controls to make <b>{{ survivor.sheet.name }}</b> into a 
            Savior: this will add all Abilities & Impairments, increase
            the survivor's natural affinities and tag them.
        </p>

        <div
            class="kd capsule full_width affinity_red clickable"
            ng-click="setSaviorStatus('red')"
        >
            Dream of the Beast
        </div>
        <div
            class="kd capsule full_width affinity_green clickable"
            ng-click="setSaviorStatus('green')"
        >
            Dream of the Crown
        </div>
        <div
            class="kd capsule full_width affinity_blue clickable"
            ng-click="setSaviorStatus('blue')"
        >
            Dream of the Lantern
        </div>

        <button
            class="kd_kickstarter_button"
            ng-if = "survivor.sheet.savior !== false"
            ng-click = "unsetSaviorStatus()"
        >
            Unset Savior Info
        </button>

    </div> <!-- modal-content -->

</div> <!-- modalSavior -->


<!-- controls of death -->



<!-- Modal affinities controller -->
<div
    id="modalAffinity"
    class="modal hidden"
    ng-if="survivor !== undefined"
    ng-click="
        ngHide('modalAffinity');
        savedAlert()
    "
>
    <div
        class="modal-content survivor_affinities_modal gear_card_gradient"
        ng-click="$event.stopPropagation()"
    >

        <div
            class="clickable corner_close_modal"
            ng-click="
                setAffinities();
                ngHide('modalAffinity');
                savedAlert()
            "
        >
        </div>

        <h3 class="kd_title">Survivor Affinities</h3>

        <p>
            Adjust permanent affinities for <b>{{survivor.sheet.name}}</b>.
            Changes are saved automatically.
        </p>

        <div class="survivor_sheet_affinity_controls_container">

            <div
                ng-repeat="color in ['red','green','blue']"
                class="survivor_sheet_affinity_controls_repeater"
            >
                <div
                    class="vertical_tumbler_container"
                    title="{{ color }} affinity controls"
                >
                    <button
                        ng-click="survivor.sheet.affinities[color] = survivor.sheet.affinities[color] + 1"
                    >
                        &#x25B2;
                    </button>
                    <input
                        id="{{color}}CountBox"
                        name="{{color}}_affinities"
                        type="number"
                        disabled
                        ng-value="survivor.sheet.affinities[color]"
                    />
                    <button
                        ng-disabled="survivor.sheet.affinities[color] < 1"
                        ng-click="survivor.sheet.affinities[color] = survivor.sheet.affinities[color] - 1"
                    >
                        &#x25BC;
                    </button>
                </div>

                <div class="affinity_block affinity_{{color}}">&nbsp;</div>

            </div> <!-- survivor_sheet_affinity_controls_repeater -->

        </div> <!-- survivor_sheet_affinity_controls_container -->

        <button
            class="clickable kd capsule blue"
            ng-click="
                setAffinities();
                ngHide('modalAffinity');
                savedAlert()
            "
        >
            Save and Close
        </button>


    </div> <!-- modal-content -->
</div> <!-- modalAffinity -->



<!-- this has to close everything, including the fold -->
</div><!-- end of the survivorSheetController scope -->
