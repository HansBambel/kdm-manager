<div
    id="settlementSheetSheetTab"
    class="view_tab"
    ng-show='tabsObject.activeTab === 0'
    ng-if="settlement.sheet"
>

    <div id="settlementSheetLeftColumn">

        <div
            id="settlementName"
            contentEditable="true"
            class="settlement_name"
            ng-model="scratch.newSettlementName"
            ng-placeholder="Settlement Name"
            ng-blur="setSettlementName()"
            title="Tap or click to edit settlement name!"
        >
            {a settlement.sheet.name a}
        </div>

        <p
            id="campaign_type"
            class="campaign_type"
            title="Campaign type may not be changed after a settlement is created!"
        >
            {a settlement.game_assets.campaign.name a}
        </p>

        <h1
            ng-if="settlement && settlement.sheet.abandoned"
            class="settlement_abandoned_stamp"
        >
            ABANDONED
        </h1>


        <!-- settlement sheet tumblers start here -->
		<div
			id="settlementTumblerScold"
			class="ng_fade kd_sheet_ui_row_tip"
			ng-click="ngShowHide('settlementTumblerScold')"
		    ng-if="
				user.user.preferences.show_ui_tips &&
				scratch.showSettlementTumblerScold
			"
		>

			<p>
                The Manager tracks the settlement's Survival Limit,
                Population and Death Count automatically. Please use the manual
                controls below with care!
            </p>

			<p>(Tap or click to dismiss.)</p>

		</div>

		<div
			id="lanternYearScold"
			class="ng_fade kd_sheet_ui_row_tip"
			ng-click="scratch.showLanternYearScold = false"
		    ng-if="scratch.showLanternYearScold"
		>   

            <p>
                Please click on the menu button in the upper left corner
                and use the <b>Timeline</b> controls to update the Lantern Year.
            </p>

			<p>(Tap or click to dismiss.)</p>

		</div>

        <div
			class="settlement_sheet_tumblers_container"
		>

            <div
                class="settlement_sheet_tumbler"
            >
                <div
                    class="settlement_sheet_tumbler_click_on"
                    ng-click="scratch.showLanternYearScold = true"
                >
                    <div
                        class="settlement_sheet_tumbler_number"
                    >
                            {a settlement.sheet.lantern_year a}
                    </div>
                    <div
                        class="settlement_sheet_tumbler_name"
                    >
                        Lantern Year
                    </div>
                </div> <!-- tumbler_click_on -->
            </div> <!-- one-off tumbler -->

            <div
                class="settlement_sheet_tumbler"
                ng-repeat="attrib in [
                    'survival_limit', 'population', 'death_count'
                ]"
            >

                <div
                    class="settlement_sheet_tumbler_click_on"
                    ng-click="
				        scratch.showSettlementTumblerScold = true;
                        rollUp(attrib + 'Controls')
                    "
                >

                    <div
                        class="settlement_sheet_tumbler_number"
                        ng-class="{
                            'active': ngRolledUp[attrib + 'Controls'] === false,
                        }"
                    >
                        {a settlement.sheet[attrib] a}
                    </div>

                    <div
                        class="settlement_sheet_tumbler_name"
                        ng-if="ngRolledUp[attrib + 'Controls'] !== false"
                    >
                        {a attrib.replace("_", " ") a}
                    </div>
                    <div
                        class="settlement_sheet_tumbler_name"
                        ng-if="ngRolledUp[attrib + 'Controls'] === false"
                    >
                        &#9662;
                    </div>

                </div> <!-- tumbler_click_on -->

            </div> <!-- settlement_sheet_tumbler repeater -->

            <!-- lantern research level -->

            <div
                class="settlement_sheet_tumbler"
                ng-if="
                    settlement.sheet.locations.indexOf('exhausted_lantern_hoard') != -1
                "
            >
                <div
                    class="settlement_sheet_tumbler_click_on"
                    ng-click="rollUp('lanternResearchControls')"
                >
                    <div
                        class="settlement_sheet_tumbler_number"
                        ng-class="{
                            'active': ngRolledUp['lanternResearchControls'] === false,
                        }"
                    >
                            {a settlement.sheet.lantern_research_level a}
                    </div>
                    <div
                        class="settlement_sheet_tumbler_name"
                        ng-if="ngRolledUp['lanternResearchControls'] !== false"
                    >
                        Lantern Research
                    </div>
                    <div
                        class="settlement_sheet_tumbler_name"
                        ng-if="ngRolledUp['lanternResearchControls'] === false"
                    >
                        &#9662;
                    </div>
                </div> <!-- tumbler_click_on -->
            </div> <!-- one-off tumbler -->

        </div> <!-- TUMBLERs END; tumbler controls begin! -->


        <div class="settlement_sheet_tumbler_controls_container">

            <div
                id="survival_limitControls"
                class="kd_sheet_ui_roll_down rolled_up settlement_sheet_tumbler_controls"
            >

                <div class="settlement_sheet_tumbler_control_title">
                    Survival Limit
                </div>

                <div class="settlement_sheet_tumbler_control_raft">
                    <button
                        ng-click="incrementAttrib('survival_limit', 1)"
                    >
                       &#9652;
                    </button>

                    <button
                        ng-click="incrementAttrib('survival_limit', -1)"
                        ng-disabled= "
                            settlement.sheet.survival_limit === settlement.sheet.minimum_survival_limit
                        "
                    >
                        &#9662;
                    </button>
                </div> <!-- control raft -->

                <div class="settlement_sheet_tumbler_tip">

                    <p>
                        The minimum Survival Limit for <b>{a settlement.sheet.name a}</b>,
                        based on settlement innovations and principles, is 
                        <b>{a settlement.sheet.minimum_survival_limit a}</b>.
                        <span ng-if="settlement.sheet.enforce_survival_limit == true">
                            The settlement Survival <i>Limit</i> of
                            <b>{a settlement.sheet.survival_limit a}</b> is
                            automatically enforced on the Survivor Sheet!
                        </span>
                        <span ng-if="settlement.sheet.enforce_survival_limit == false">
                            Due to expansion or campaign rules, the settlement
                            Survival Limit of <b>{a settlement.sheet.survival_limit a}</b>
                            is <u>not</u> enforced on the Survivor Sheet!
                        </span>
                    </p>

                </div> <!-- tip -->

                <div
                    class="settlement_sheet_tumbler_close_button_container"
                    ng-click="
                        rollUp('survival_limitControls');
                    "
                >
                    <button class="kd_kickstarter_button kd_blue">Save and Close</button>
                </div>

            </div> <!-- survivalControls -->


            <div
                id="populationControls"
                class="kd_sheet_ui_roll_down rolled_up settlement_sheet_tumbler_controls"
            >

                <div class="settlement_sheet_tumbler_control_title">
                    Population
                </div>

                <div class="settlement_sheet_tumbler_control_raft">

                    <button
                        ng-click="incrementAttrib('population', 1)"
                    >
                        &#9652;
                    </button>
                    <button
                        ng-click="incrementAttrib('population', -1)"
                        ng-disabled= "
                            settlement.sheet.population === settlement.sheet.minimum_population
                        "
                    >
                        &#9662;
                    </button>

                </div> <!-- control raft -->

                <div class="settlement_sheet_tumbler_tip">

                    <p>
                        The minimum Population for <b>{a settlement.sheet.name a}</b>,
                        based on the total number of living survivors in the
                        settlement, is <b>{a settlement.sheet.minimum_population a}</b>.
                    </p>

                </div> <!-- tip -->

                <div
                    class="settlement_sheet_tumbler_close_button_container"
                    ng-click="rollUp('populationControls')"
                >
                    <button class="kd_kickstarter_button kd_blue">Save and Close</button>
                </div>

            </div> <!-- POPULATION controls END -->


            <div
                id="death_countControls"
                class="kd_sheet_ui_roll_down rolled_up settlement_sheet_tumbler_controls"
            >

                <div class="settlement_sheet_tumbler_control_title">
                    Death Count
                </div>

                <div class="settlement_sheet_tumbler_control_raft">

                    <button
                        ng-click="incrementAttrib('death_count',1)"
                    >
                        &#9652;
                    </button>
                    <button
                        ng-click="incrementAttrib('death_count',-1)"
                        ng-disabled= "
                            settlement.sheet.death_count === settlement.sheet.minimum_death_count
                        "
                    >
                        &#9662;
                    </button>

                </div> <!-- control raft -->

                <div class="settlement_sheet_tumbler_tip">

                    <p>
                        The minimum Death Count for <b>{a settlement.sheet.name a}</b>,
                        based on the total number of dead survivors in the
                        settlement, is <b>{a settlement.sheet.minimum_death_count a}</b>.
                    </p>

                </div> <!-- tip -->

                <div
                    class="settlement_sheet_tumbler_close_button_container"
                    ng-click="rollUp('death_countControls')"
                >
                    <button class="kd_kickstarter_button kd_blue">Save and Close</button>
                </div>

            </div> <!-- DEATH COUNT controls -->

            <div
                id="lanternResearchControls"
                class="kd_sheet_ui_roll_down rolled_up settlement_sheet_tumbler_controls"
            >
                <div class="settlement_sheet_tumbler_control_title">
                    Lantern Research Level
                </div>

                <div class="settlement_sheet_tumbler_control_raft">
                    <button
                        ng-click="incrementAttrib('lantern_research_level', 1)"
                    >
                       &#9652;
                    </button>

                    <button
                        ng-click="incrementAttrib('lantern_research_level', -1)"
                        ng-disabled= "
                            settlement.sheet.lantern_research_level === 0
                        "
                    >
                        &#9662;
                    </button>
                </div> <!-- control raft -->

                <div class="settlement_sheet_tumbler_tip">
                    <p>
                        <b>Once per lantern year, spend 2 x Bone, 2 x hide,
                        2 x organ to research.</b>
                    </p>
                    <p>
                        If you do, gain the next level of Lantern Research.
                    </p>
                    <p>
                        Corresponding <b>Pulse Discoveries</b> are displayed
                        on the Campaign Summary view.
                    </p>
                </div> <!-- tip -->

                <div
                    class="settlement_sheet_tumbler_close_button_container"
                    ng-click="
                        rollUp('lanternResearchControls');
                    "
                >
                    <button class="kd_kickstarter_button kd_blue">Save and Close</button>
                </div>

            </div> <!-- lanternResearchControls -->

        </div> <!-- settlement_sheet_tumbler_controls_container -->

        <!-- MILESTONES -->

        <div>

            <h2 class="kd worksheet_page_title">
                Milestone Story Events
            </h2>

            <p>
                Trigger these story events when the milestone condition is met.
            </p>

            <div
                ng-repeat="m in settlement.game_assets.milestones_options"
                class="clickable hover_highlight kd worksheet_row lined principle"
                ng-click="
                    toggleArrayItem(settlement.sheet.milestone_story_events, m.handle);
                    setSettlementAttribute('milestone_story_events');
                "
            >
                <div
                    class="kd checkbox"
                    ng-class="{
                        'checked': settlement.sheet.milestone_story_events.indexOf(m.handle) != -1
                    }"
                >
                </div>

                <div>
                    {a m.name a}
                </div>

                <div class="font_small">
                    <font class="kdm_font">g</font>
                    <b>{a m.story_event a}</b>
                    <span class="milestone_story_reference">
                        (p.{a settlement.game_assets.events[m.story_event_handle].page a})
                    </span>
                </div>

            </div> <!-- milestone repeater div -->

        </div> <!-- anonymous div for milestones -->


        <!-- PRINCIPLES -->
        <div>

            <h2 class="kd worksheet_page_title">Principles</h2>

            <p>The settlement's established principles.</p>

            <div
                class="settlement_sheet_principles_spinner_container"
                ng-if="settlement.sheet.principles === undefined"
            >
                <img src="/static/media/loading_io.gif" />
                <p>Updating settlement principles...</p>
            </div>

            <!-- two repeaters here, because each principle has options we nee
                to iterate -->
            <div
                ng-repeat="p in settlement.game_assets.principles_options"
                ng-if="settlement.sheet.principles !== undefined"
            >
                <div
                    class="kd worksheet_row lined"
                    ng-repeat="o in p.options"
                    ng-if="o.checked"
                >
                    <div class="kd checkbox checked"></div>
                    <div class="kd checkbox_desc">{a o.name a}</div>
                </div>

            </div> <!-- principle repeater -->

            <button
                class="kd capsule full_width"
                ng-click="ngShow('settlementSheetPrinciplesEditorModal')"
            >
                Edit principles
            </button>

        </div> <!-- principles settlement sheet block group -->

        <div
            id="settlementSheetPrinciplesEditorModal"
            ng-click="ngHide('settlementSheetPrinciplesEditorModal')"
            ng-if="
                ngVisible['settlementSheetPrinciplesEditorModal']
            "
            class="modal-black hidden"
        >
            <div class="kd_sheet_ui_outer_ring_container">

                <div
                    id="settlementSheetPrinciplesControls"
                    class="kd_sheet_ui_inner_ring_container"
                    ng-click="$event.stopPropagation()"
                >

                <h3 class="kd title">Principles</h3>

                <p>The settlement's established principles.</p>

                <p
                    class="kd_sheet_ui_row_tip"
                    ng-if="user.user.preferences.show_ui_tips"
                    ng-if="settlement.sheet.principles !== undefined"
                >
                    Bonuses to <b>living</b> survivors are applied immediately
                    when a principle is selected. Bonuses to <b>new</b> and
                    <b>newborn</b> survivors are applied automatically
                    thereafter.
                </p>

                <div
                    class="settlement_sheet_principles_spinner_container"
                    ng-if="settlement.sheet.principles === undefined"
                >
                    <img src="/static/media/loading_io.gif" />
                    <p>Updating settlement principles...</p>
                </div>

                <div
                    ng-repeat="p in settlement.game_assets.principles_options"
                    class="settlement_sheet_principle_repeater"
                    ng-if="settlement.sheet.principles !== undefined"
                >

                    <div
                        class="settlement_sheet_principle_name"
                    >
                        {a p.name a}
                    </div>

                    <div
                        class="clickable principle_option editor"
                        ng-repeat="o in p.options"
                        ng-click="set(p.handle, o)"
                    >
                        <div
                            class="principle_option_title"
                        >
                            <div
                                class="kd_sheet_ui_box"
                                ng-class="{
                                    'checked': o.checked,
                                }"
                            >
                            </div>
                            <div class="principle_option_name">
                                {a  o.name  a}
                            </div>
                        </div>

                        <div
                            class="principle_option_desc"
                            ng-bind-html="o.desc|trustedHTML"
                        >
                        </div>


                    </div> <!-- individual principle option repeater-->

                </div> <!-- principle repeater -->



                <div
                    class="ng_fade unset_principle_container"
                    ng-if="
                        settlement.sheet.principles !== undefined &&
                        settlement.game_assets.principles_options !== undefined
                    "
                >
                
                    <p
                        class="kd_sheet_ui_row_tip"
                        ng-if="user.user.preferences.show_ui_tips"
                    >
                        Select a principle from the list below to unset it. The
                        Manager will automatically undo any changes that were
                        made when the principle was selected.
                    </p>

                    <select
                        class="kd capsule full_width"
                        ng-model="scratch.unset"
                        ng-change="unsetPrinciple();"
                        ng-options="p.handle as p.name for p in settlement.game_assets.principles_options"
                    >
                        <option disabled value="">Unset Principle</option>
                    </select>

                </div> <!-- unset_principle_container -->



                </div> <!-- sheet ui INNER ring -->
    
                <button
                    class="kd_kickstarter_button floating_close_modal_button"
                    ng-click="ngHide('settlementSheetPrinciplesEditorModal')"
                >
                    Close
                </button>


            </div> <!-- sheet ui outer ring -->
        </div><!-- principles editor-->

        <!-- inspirational statue -->
        <div
            class="settlement_sheet_block_group"
            ng-if="settlement.sheet.innovations.indexOf('sculpture') != -1"
            title="Use these controls to manage your settlement's Inspirational Statue!"
        >
            <h2>Inspirational Statue</h2>
            <p>A settlement can only have one Inspirational Statue.</p>

            <div class="line_item">
                <span class="empty_bullet" ng-if="settlement.sheet.inspirational_statue == undefined"/></span>
                <span class="bullet" ng-if="settlement.sheet.inspirational_statue != undefined"/></span>
                <select
                    class="kd capsule full_width"
                    ng-model="settlement.sheet.inspirational_statue"
                    ng-options="
                        fa_dict.handle as fa_dict.name disable when fa_dict.select_disabled for fa_dict in settlement.game_assets.inspirational_statue_options
                    "
                    ng-change="setInspirationalStatue()"
                    ng-selected="settlement.sheet.inspirational_statue"
                >
                    <option disabled value="">Select a Fighting Art</option>
                </select>
            </div> <!-- line_item -->
        </div>

        <!-- monster volumes -->
        <div
            class="settlement_sheet_block_group"
            ng-if="settlement.sheet.innovations.indexOf('records') != -1"
            title="Click or tap on an item to remove it from this list."
        >

            <h2>Monster Volumes</h2>
            <p>There can be up to 3 volumes for each monster.</p>

            <div
                class="line_item location_container"
                ng-repeat="v in settlement.sheet.monster_volumes"
            >
                <span class="bullet"></span>
                <span
                    class="item"
                    ng-click="rmMonsterVolume($index, v)"
                >
                    {a v a}
                </span>
            </div> <!-- line_item -->

            <div class="line_item">
                <span class="empty_bullet"></span>
                <select
                    class="kd capsule full_width"
                    ng-model="scratch.monster_volume"
                    ng-options="m_string for m_string in settlement.game_assets.monster_volumes_options"
                    ng-change="addMonsterVolume()"
                >
                    <option disabled value="">Add a Monster Volume</option>
                </select>
            </div> <!-- line_item -->

        </div>


    </div> <!-- asset_management_left_pane/left column -->



    <!-- MIDDLE COLUMN STARTS HERE -->

    <div id="settlementSheetMiddleColumn">

        <!-- locations -->
        <div
            title="Click or tap an item to remove it from this list."
        >

            <h2 class="kd worksheet_page_title">Settlement Locations</h2>

            <p>Locations in your settlement.</p>

            <div
                class="clickable kd worksheet_row lined hover_highlight_red"
                ng-repeat="loc in settlement.sheet.locations"
                ng-init="
                    l_dict = kingdomDeath.locations[loc];
                    l_index = settlement.sheet.locations.indexOf(loc);
                "
            >

                <div class="kd checkbox checked"></div>

                <div
                    class="kd checkbox_desc hover_highlight_red"
                    ng-click="
                        settlement.sheet.locations.splice(l_index, 1);
                        postJSONtoAPI(
                            'settlement', 'rm_location', settlement.sheet._id.$oid,
                            {'handle': l_dict.handle},
                            false, true, true
                        );
                    "
                >
                    {a l_dict.name a}
                </div>

                <span
                    ng-if="l_dict.levels !== undefined"
                    ng-init="locationLevel = (settlement.sheet.location_levels[loc]) || 1"
                    class="location_lvl_select"
                >
                    <select
                        class="location_level"
                        ng-model="locationLevel"
                        ng-options="locationLevel as 'Lvl. '+ locationLevel for locationLevel in [1,2,3]"
                        ng-change="setLocationLevel(loc, locationLevel)"
                        ng-selected="locationLevel"
                    >
                    </select>
                </span> <!-- optional levels controls -->

            </div> <!-- line_item location_container: list/rm locations -->

            <select
                class="kd capsule full_width green"
                ng_model="newLocation"
                ng_change="
                    newLocation !== null &&
                    postJSONtoAPI(
                        'settlement', 'add_location', settlement.sheet._id.$oid,
                        {'handle': newLocation},
                        false, true, true
                    );
                "
                ng-options="
                    loc.handle as loc.name disable
                    when settlement.sheet.locations.indexOf(loc.handle) !== -1
                    for loc in settlement.game_assets.locations
                "
            >
                <option value="" disabled selected>Add Location</option>
            </select>

        </div> <!-- settlement_sheet_block_group locations controller-->




                    <!-- INNOVATIONS -->

        <a id="edit_innovations" class="mobile_only"/></a>


        <div
            class="settlement_sheet_block_group"
            title="Click or tap on an item to remove it from this list."
        >

            <h2 class="kd worksheet_page_title">Innovations</h2>

            <p>The settlement's innovations (including weapon masteries).</p>

            <div
                class="line_item location_container"
                ng-repeat="i in settlement.sheet.innovations"
                ng-init="
                    i_dict = settlement.game_assets.innovations[i]
                "
            >
                <span class="bullet"></span>
                <span
                    class="clickable"
                    class="item"
                    ng-click="rmInnovation($index,i)"
                >
                    {a i_dict.name a}
                </span>
                <span
                    ng-if="i_dict.levels !== undefined"
                    ng-init="innovationLevel = (settlement.sheet.innovation_levels[i]) || 1"
                    class="location_lvl_select"
                >
                    <select
                        class="location_level"
                        ng-model="innovationLevel"
                        ng-options="innovationLevel as 'Lvl. '+ innovationLevel for innovationLevel in [1,2,3]"
                        ng-change="setInnovationLevel(i,innovationLevel)"
                        ng-selected="innovationLevel"
                    >
                    </select>
                </span> <!-- optional levels controls -->
            </div>

            <div class="line_item">
                <span class="empty_bullet" /></span>
                <select
                    class="kd capsule full_width blue"
                    name="add_innovation"
                    ng_model="newInnovation"
                    ng_change="addInnovation()"
                    ng-options="i.handle as i.name for i in innovationOptions"
                >
                    <option value="" disabled selected>Add Innovation</option>
                </select>
            </div>

            <div
                id="innovationDeckContainer"
                class="innovation_deck kd_sheet_ui_border_box"
                title="The current innovation deck for {a settlement.sheet.name a}. Tap or click to refresh!"
                ng-if="settlement.sheet.innovations.length != 0"
                ng-init="setInnovationDeck()"
            >
                <h3 class="kd_title">Innovation Deck</h3>

                <div
                    id="innovationDeckSpinner"
                    class="ng_fade inline_spinner_container"
                    ng-if="ngVisible['innovationDeckSpinner']"
                >
                    <img
                        src="/static/media/loading_io.gif"
                    />
                    <p>Refreshing Innovation Deck...</p>
                </div>

                <ul
                    class="asset_deck clickable"
                    ng-click="setInnovationDeck()"
                >
                    <li ng-repeat="(handle, dict) in innovation_deck"> {a dict['name'] a} </li>
                </ul>

                <div
                    class="innovation_quick_pick_container"
                    ng-if="user.user.subscriber.level > 1"
                >
                    <button
                        id="innovationQuickPickLauncher"
                        class="kd_kickstarter_button kd_blue"
                        ng-if="innovation_deck != undefined"
                        ng-click="
                            ngShowHide('innovationQuickPickLauncher');
                            ngShowHide('innovationQuickPick')
                        "
                        ng-click="createInnovationQuickPick()"
                    >
                        Innovate!
                    </button>
                    <div
                        id="innovationQuickPick"
                        class="innovation_quick_pick hidden"
                    >
                        <div class="kd_sheet_ui_row_tip">
                            Click on an innovation below to add it to settlement innovations!
                        </div>
                        <div
                            class="clickable innovation_quick_pick_item card_gradient"
                            ng-repeat="h in innovationQuickPickOptions"
                            ng-init="i = settlement.game_assets.innovations[h]"
                            ng-click="addInnovation(h); showHide('innovationQuickPick')"
                        >
                            <div class="innovation_name">{a i.name a}</div>
                            <div class="innovation_consequences" ng-if="i.consequences.length > 0">
                                Consequences:
                                <span
                                    class="innovation_consequences_repeater"
                                    ng-repeat="c_handle in i.consequences track by $index"
                                    ng-if="settlement.game_assets.innovations[c_handle]"
                                >
                                    {a settlement.game_assets.innovations[c_handle].name a}
                                <span>
                            </div>
                            <div
                                class="innovation_survival_limit_bar"
                                ng-if="i.survival_limit != undefined"
                            >
                                Survival Limit +{a i.survival_limit a}
                            </div>
                        </div>
                        <button
                            class="kd_kickstarter_button kd_blue"
                            ng-if="innovation_deck != undefined"
                            ng-click="createInnovationQuickPick()"
                        >
                            Draw again!
                        </button>
                        <button
                            class="kd_kickstarter_button kd_pink"
                            ng-click="
                                ngHide('innovationQuickPickLauncher');
                                ngHide('innovationQuickPick')
                            "
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            
            </div> <!-- innovationDeckContainer -->


        </div> <!-- settlement_sheet_block_group innovations-->




    </div> <!-- asset_management_left_pane -->



    <!-- END OF LEFT PANE -->



    <div
        id="settlementSheetRightColumn"
        ng-if="settlement !== undefined"
    >

    <!--
        outermost containers in this 'column' should only ever be of the
        kd_sheet_ui_border_box class; DO NOT put settlement_sheet_block_group 
        elements in this 'column' anymore; they belong in the other columns!
    -->


                    <!-- STRAIN MILESTONES -->
        <span
            class="hidden"
            ng-if="settlement != undefined"
            ng-init="scratch.show_strain_milestone_controls = strainMilestonesPresent()"
        >HACK CITY!!!</span>

        <div
            class="kd_sheet_ui_border_box"
            ng-if="scratch.show_strain_milestone_controls"
        >
            <div
                class="settlement_sheet_kd_sheet_ui_box"
                title="Strain Milestones controller for {a settlement.sheet.name a}. Tap or click to toggle!"
            >
                <div class="kd_sheet_ui_row title">
                     Strain Milestones
                </div>
                <div class="kd_sheet_ui_row">
                    During the Check Milestones step of the Settlement Phase, check the Milestone Strain cards first.
                </div>

                <div
                    class="strain_milestone_toggle_box hover_highlight clickable"
                    ng-repeat="m in settlement.game_assets.strain_milestones"
                    ng-click="toggleStrainMilestone(m.handle)"
                    ng-class="{active: settlement.sheet.strain_milestones.includes(m.handle)}"
                >
                    <span
                        class="kd_sheet_ui_box"
                        ng-class="{
                            checked: settlement.sheet.strain_milestones.indexOf(m.handle) != -1
                        }"
                    ></span>

                    <b>{a m.name a}</b> 

                    <div
                        class="ng_fade strain_milestone_condition"
                        ng-if="settlement.sheet.strain_milestones.indexOf(m.handle) == -1"
                        ng-bind-html="m.milestone_condition|trustedHTML">
                    </div>

                    <div
                        class="ng_fade strain_milestone_condition"
                        ng-if="settlement.sheet.strain_milestones.indexOf(m.handle) != -1"
                        ng-bind-html="m.permanent_effect|trustedHTML">
                    </div>

                    <div
                        class="strain_milestone_fighting_arts"
                    >
                        <span
                            ng-repeat="fa in settlement.game_assets.strain_milestones[m.handle].fighting_arts"
                            ng-class="{
                                faded: settlement.sheet.strain_milestones.indexOf(m.handle) == -1,
                                unlocked_strain_fa: settlement.sheet.strain_milestones.indexOf(m.handle) != -1
                            }"
                        >
                            <span
                                ng-if="settlement.sheet.strain_milestones.indexOf(m.handle) == -1"
                            >
                                &#x1F512;
                            </span>
                            <span
                                ng-if="settlement.sheet.strain_milestones.indexOf(m.handle) != -1"
                            >
                                &#x1F513; 
                            </span>
                            <b>{a settlement.game_assets.fighting_arts[fa].name a}</b> fighting art
                        </span>
                    </div>

                </div> <!-- milestone div -->

            </div> <!-- settlement_sheet_kd_sheet_ui_box -->

        </div> <!-- kd_sheet_ui_border_box for milestones -->

        <!-- /end strain -->


    <div
       class="kd_sheet_ui_border_box"
    >
        <div
            class="settlement_sheet_kd_sheet_ui_box"
            title="Quarries controller for {a settlement.sheet.name a}. Tap or click to remove!"
        >
            <div class="kd_sheet_ui_row title font_large">
                 Quarries
            </div>
            <div class="kd_sheet_ui_row">
                The monsters your settlement can select to hunt.
            </div>
            <div
                class="settlement_sheet_line_item location_container clickable"
                ng-repeat="q in settlement.sheet.quarries"
            >
                <span class="hidden">{a a a}</span>
                <span class="kd_sheet_ui_box checked"></span>
                <span
                    class="item"
                    ng-click="removeQuarry($index, q)"
                >
                    {a settlement.game_assets.monsters[q].name a}
                </span>
            </div>
        </div> <!-- settlement_sheet_kd_sheet_ui_box -->

        <span class="empty_bullet" /></span>
        <select
            class="kd capsule"
            ng-model="addQuarryMonster"
            ng-options="q.handle as q.name for q in settlement.game_assets.quarry_options"
            ng-change="addQuarry($index)"
        >
            <option selected disabled value="">Add Quarry Monster</option>
        </select>

    </div> <!-- quarriesController -->

    <!-- NEMESIS MONSTERS -->
    <div
        class="nemesis_monsters_controls_container kd_sheet_ui_border_box"
    >
        <div
            class="settlement_sheet_kd_sheet_ui_box"
            title="Nemesis Encounters controller for {a settlement.sheet.name a}. Tap or click to edit!"
        >
            <div class="font_large kd_sheet_ui_row title">
                <img
                    class="kd_icon"
                    src="/static/media/nemesis_encounter_event.jpg"
                    ng-class="{
                        'invert_image': user.user.preferences.night_mode === true,
                    }"
                />
                Nemesis Monsters
            </div>
            <div class="kd_sheet_ui_row">
                The available nemesis encounter monsters.
            </div>
            <div
                class="settlement_sheet_line_item settlement_sheet_nemesis_line_item"
                ng-repeat="n in settlement.sheet.nemesis_monsters"
            >
                <div class="nemesis_clicker clickable" ng-click="rmNemesis($index,n)">
                    <span class="kd_sheet_ui_box checked"></span>
                    <span>{a settlement.game_assets.monsters[n].name a}</span>
                </div>
                <div class="nemesis_levels_container">
                    <div
                        class="nemesis_level_toggle clickable"
                        ng-repeat="l in range(settlement.game_assets.monsters[n].levels, 'increment')"
                        ng-click="toggleNemesisLevel(n,l)"
                    >
                        <span
                            class="kd_sheet_ui_box"
                            ng-class="{checked: settlement.sheet.nemesis_encounters[n].indexOf(l) != -1}"
                        ></span>
                        Lvl {a l a}
                    </div>
                </div>

            </div><!-- nemesis repeater / line item -->
        </div> <!-- settlement_sheet_kd_sheet_ui_box -->

        <select
            class="kd capsule full_width"
            ng-model="addNemesisMonster"
            ng-options="n.handle as n.name for n in settlement.game_assets.nemesis_options"
            ng-change="addNemesis()"
        >
            <option selected disabled value="">Add Nemesis Monster</option>
        </select>

    </div> <!-- nemesis_monsters_controls_container -->


    <!-- DEFEATED MONSTERS -->
    <div
        class="kd_sheet_ui_border_box"
        title="Click or tap an item to remove it from this list."
    >
        <div
            class="settlement_sheet_kd_sheet_ui_box"
            title="Defeated Monsters controller for {a settlement.sheet.name a}. Tap or click to remove!"
        >
            <div class="font_large kd_sheet_ui_row title">
                Defeated Monsters
            </div>
            <div class="kd_sheet_ui_row">
                A list of defeated monsters and their level.
            </div>
            <div
                class="clickable settlement_sheet_line_item defeated_monsters_container"
                ng-repeat="x in settlement.sheet.defeated_monsters track by $index"
            >
                <span class="kd_sheet_ui_box checked"></span>
                <span class="item" ng-click="rmDefeatedMonster($index, x)">
                    {a x a}
                </span>
            </div>
        </div><!-- settlement_sheet_kd_sheet_ui_box -->

        <div class="line_item">
            <span class="empty_bullet" /></span>
            <select
                class="kd capsule full_width"
                ng-model="dMonst"
                ng-change="addDefeatedMonster()"
                ng-options="d as d for d in settlement.game_assets.defeated_monsters "
            >
                <option selected disabled value="">Add Defeated Monster</option>
            </select>
        </div> <!-- line_item -->
    </div> <!-- defeatedMonstersController -->


    <!-- LOST SETTLEMENTS app -->
    <div
        class="lost_settlement_controls_container kd_sheet_ui_border_box"
    >
        <div
            class="settlement_sheet_kd_sheet_ui_box clickable"
            ng-click="rollUp('lostSettlementsControl')"
            title="
                Lost Settlements controller for {a settlement.sheet.name a}.
                Tap or click to edit!
            "
        >

            <div class="font_large kd_sheet_ui_row title">
                Lost Settlements
            </div>

            <div class="kd_sheet_ui_box_row wrap">
                <span
                    class="kd_sheet_ui_box"
                    ng-repeat="
                        lostCount in [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]
                    "
                    ng-class="{
                        'checked': settlement.sheet.lost_settlements > lostCount,
                        'heavy': [4,9,14,18].indexOf(lostCount) !== -1,
                    }"
                ></span>
            </div>

            <hr>

            <div class="kd_sheet_ui_row story_tip">
                <font class="kdm_font">g</font>
                <b> Game Over</b>
                <span class="font_small">
                    (p. {a settlement.game_assets.events['core_game_over'].page a})
                </span>
            </div>

        </div> <!-- settlement_sheet_kd_sheet_ui_box -->

            <div
                id="lostSettlementsControl"
                class="kd_sheet_ui_roll_down rolled_up"
            >
                <div
                    class="kd_sheet_ui_roll_down_controls embedded"
                    ng-if="ngRolledUp['lostSettlementsControl'] === false"
                >
                    <div class="kd_sheet_ui_row dynamic_tip wrap">
                        <div class="font_small dynamic_tip_container">
                            <div
                                class="kd_sheet_ui_box small"
                                ng-class="{checked: settlement.sheet.lost_settlements > 4}"
                            ></div>
                            <span>
                                Left Overs
                            </span>
                        </div>
                        <div class="font_small dynamic_tip_container">
                            <div
                                ng-repeat="box in [0,1]"
                                class="kd_sheet_ui_box small"
                                ng-class="{checked: settlement.sheet.lost_settlements > 9}"
                            ></div>
                            <span>
                                Those Before Us
                            </span>
                        </div>
                        <div class="font_small dynamic_tip_container">
                            <div
                                ng-repeat="box in [0,1,2]"
                                class="kd_sheet_ui_box small"
                                ng-class="{checked: settlement.sheet.lost_settlements > 14}"
                            ></div>
                            <span>
                                Ocular Parasites
                            </span>
                        </div>
                        <div class="font_small dynamic_tip_container">
                            <div
                                ng-repeat="box in [0,1,2,3]"
                                class="kd_sheet_ui_box small"
                                ng-class="{checked: settlement.sheet.lost_settlements > 19}"
                            ></div>
                            <span>
                                Rainy Season
                            </span>
                        </div>
                    </div><!-- kd_sheet_ui_row.dynamic_tip.wrap -->

                    <div class="kd_sheet_ui_number_tumbler">

                        <button
                            class="kd capsule"
                            ng-click="settlement.sheet.lost_settlements = settlement.sheet.lost_settlements + 1"
                        >
                            &#x25B2;
                        </button>

                        <button
                            class="kd capsule"
                            ng-click="settlement.sheet.lost_settlements = settlement.sheet.lost_settlements - 1"
                        >
                            &#x25BC;
                        </button>

                        <button
                            class="kd capsule blue"
                            ng-click="
                                setLostSettlements();
                                rollUp('lostSettlementsControl');
                            "
                        >
                            Save Changes
                        </button>

                    </div> <!-- number tumbler -->

                </div> <!-- kd_sheet_ui_roll_down_controls.integrated -->

            </div> <!-- kd_sheet_ui_roll_down -->

        </div> <!-- lost_settlement_controls_container -->

    </div> <!-- right pane -->

</div> <!-- settlement sheet Sheet tab -->
